{"version":3,"file":"Map.FileInserter.js","sourceRoot":"","sources":["../../../../../../../../../../../TanhX/online/browser/src/map/handler/Map.FileInserter.js"],"names":[],"mappings":"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","sourcesContent":["/* -*- js-indent-level: 8 -*- */\n/*\n * L.Map.FileInserter is handling the fileInserter action\n */\n\n/* global app _ Uint8Array errorMessages */\n\nL.Map.mergeOptions({\n\tfileInserter: true\n});\n\nL.Map.FileInserter = L.Handler.extend({\n\n\tinitialize: function (map) {\n\t\tthis._map = map;\n\t\tthis._childId = null;\n\t\tthis._toInsertGraphic = {};\n\t\tthis._toInsertMultimedia = {};\n\t\tthis._toInsertURL = {};\n\t\tthis._toInsertBackground = {};\n\t\tvar parser = document.createElement('a');\n\t\tparser.href = window.host;\n\t},\n\n\tgetWopiUrl: function (map) {\n\t\treturn window.makeHttpUrlWopiSrc('/' + map.options.urlPrefix + '/', map.options.doc, '/insertfile');\n\t},\n\n\taddHooks: function () {\n\t\tthis._map.on('insertgraphic', this._onInsertGraphic, this);\n\t\tthis._map.on('insertmultimedia', this._onInsertMultimedia, this);\n\t\tthis._map.on('inserturl', this._onInsertURL, this);\n\t\tthis._map.on('childid', this._onChildIdMsg, this);\n\t\tthis._map.on('selectbackground', this._onSelectBackground, this);\n\t},\n\n\tremoveHooks: function () {\n\t\tthis._map.off('insertgraphic', this._onInsertGraphic, this);\n\t\tthis._map.off('insertmultimedia', this._onInsertMultimedia, this);\n\t\tthis._map.off('inserturl', this._onInsertURL, this);\n\t\tthis._map.off('childid', this._onChildIdMsg, this);\n\t\tthis._map.off('selectbackground', this._onSelectBackground, this);\n\t},\n\n\t_onInsertGraphic: function (e) {\n\t\tif (!this._childId) {\n\t\t\tapp.socket.sendMessage('getchildid');\n\t\t\tthis._toInsertGraphic[Date.now()] = e.file;\n\t\t}\n\t\telse {\n\t\t\tthis._sendFile(Date.now(), e.file, 'graphic');\n\t\t}\n\t},\n\n\t_onInsertMultimedia: function (e) {\n\t\tif (!this._childId) {\n\t\t\tapp.socket.sendMessage('getchildid');\n\t\t\tthis._toInsertMultimedia[Date.now()] = e.file;\n\t\t}\n\t\telse {\n\t\t\tthis._sendFile(Date.now(), e.file, 'multimedia');\n\t\t}\n\t},\n\n\t_onInsertURL: function (e) {\n\t\tif (!this._childId) {\n\t\t\tapp.socket.sendMessage('getchildid');\n\t\t\tthis._toInsertURL[Date.now()] = e;\n\t\t}\n\t\telse {\n\t\t\tthis._sendURL(Date.now(), e);\n\t\t}\n\t},\n\n\t_onSelectBackground: function (e) {\n\t\tif (!this._childId) {\n\t\t\tapp.socket.sendMessage('getchildid');\n\t\t\tthis._toInsertBackground[Date.now()] = e.file;\n\t\t}\n\t\telse {\n\t\t\tthis._sendFile(Date.now(), e.file, 'selectbackground');\n\t\t}\n\t},\n\n\t_onChildIdMsg: function (e) {\n\t\t// When childId is not created (usually when we insert file/URL very first time), we send message to get child ID\n\t\t// and store the file(s) into respective arrays (look at _onInsertGraphic, _onInsertMultimedia, _onInsertURL, _onSelectBackground)\n\t\t// When we receive the childId we empty all the array and insert respective file/URL from here\n\n\t\tthis._childId = e.id;\n\t\tfor (var name in this._toInsertGraphic) {\n\t\t\tthis._sendFile(name, this._toInsertGraphic[name], 'graphic');\n\t\t}\n\t\tthis._toInsertGraphic = {};\n\n\t\tfor (var name in this._toInsertMultimedia) {\n\t\t\tthis._sendFile(name, this._toInsertMultimedia[name], 'multimedia');\n\t\t}\n\t\tthis._toInsertMultimedia = {};\n\n\t\tfor (name in this._toInsertURL) {\n\t\t\tthis._sendURL(name, this._toInsertURL[name]);\n\t\t}\n\t\tthis._toInsertURL = {};\n\n\t\tfor (name in this._toInsertBackground) {\n\t\t\tthis._sendFile(name, this._toInsertBackground[name], 'selectbackground');\n\t\t}\n\t\tthis._toInsertBackground = {};\n\t},\n\n\t_sendFile: async function (name, file, type) {\n\t\tvar socket = app.socket;\n\t\tvar map = this._map;\n\t\tvar sectionContainer = app.sectionContainer;\n\t\tvar url = this.getWopiUrl(map);\n\n\t\tvar size;\n\n\t\tif (type === 'multimedia') {\n\t\t\tconst videoElement = document.createElement('video');\n\t\t\tconst objectURL = window.URL.createObjectURL(file);\n\t\t\tvideoElement.src = objectURL;\n\n\t\t\tconst videoLoadPromise = new Promise((resolve, reject) => {\n\t\t\t\tvideoElement.addEventListener(\"loadedmetadata\", resolve);\n\t\t\t\tvideoElement.addEventListener(\"error\", reject);\n\t\t\t});\n\n\t\t\tvideoElement.load();\n\n\t\t\tlet videoLoaded = false;\n\n\t\t\ttry {\n\t\t\t\tawait videoLoadPromise;\n\t\t\t\tvideoLoaded = true;\n\t\t\t} catch (_error) {\n\t\t\t\tsize = {\n\t\t\t\t\twidth: 0,\n\t\t\t\t\theight: 0,\n\t\t\t\t}; // 0, 0 will make core pick the minimum size - which was the behavior before we checked size like this\n\t\t\t}\n\n\t\t\tif (videoLoaded) {\n\t\t\t\tsize = {\n\t\t\t\t\twidth: videoElement.videoWidth,\n\t\t\t\t\theight: videoElement.videoHeight,\n\t\t\t\t};\n\n\t\t\t\tconst maxSize = {\n\t\t\t\t\twidth: app.file.size.cX * map.getZoomScale(10),\n\t\t\t\t\theight: app.file.size.cY * map.getZoomScale(10),\n\t\t\t\t};\n\n\t\t\t\tconst shrinkToFitFactor = Math.min(\n\t\t\t\t\t1,\n\t\t\t\t\tmaxSize.width / size.width,\n\t\t\t\t\tmaxSize.height / size.height\n\t\t\t\t);\n\n\t\t\t\tsize.width *= shrinkToFitFactor;\n\t\t\t\tsize.height *= shrinkToFitFactor;\n\t\t\t}\n\n\t\t\tvideoElement.src = undefined;\n\t\t\twindow.URL.revokeObjectURL(objectURL);\n\t\t}\n\n\t\tif ('processCoolUrl' in window) {\n\t\t\turl = window.processCoolUrl({ url: url, type: 'insertfile' });\n\t\t}\n\n\t\tif (!(file.filename && file.url) && (file.name === '' || file.size === 0)) {\n\t\t\tvar errMsg =  _('The file of type: {0} cannot be uploaded to server since the file has no name');\n\t\t\tif (file.size === 0)\n\t\t\t\terrMsg = _('The file of type: {0} cannot be uploaded to server since the file is empty');\n\t\t\terrMsg = errMsg.replace('{0}', file.type);\n\t\t\tmap.fire('error', {msg: errMsg, critical: false});\n\t\t\treturn;\n\t\t}\n\n\t\tthis._toInsertBackground = {};\n\n\t\tif (window.ThisIsAMobileApp) {\n\t\t\t// Pass the file contents as a base64-encoded parameter in an insertfile message\n\t\t\tvar reader = new FileReader();\n\t\t\treader.onload = (function(aFile) {\n\t\t\t\treturn function(e) {\n\t\t\t\t\tvar byteBuffer = new Uint8Array(e.target.result);\n\t\t\t\t\tvar strBytes = '';\n\t\t\t\t\tfor (var i = 0; i < byteBuffer.length; i++) {\n\t\t\t\t\t\tstrBytes += String.fromCharCode(byteBuffer[i]);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (type === 'multimedia') {\n\t\t\t\t\t\twindow.postMobileMessage('insertfile name=' + aFile.name + ' type=' + type +\n\t\t\t\t\t\t\t\t\t\t\t       ' data=' + window.btoa(strBytes) +\n\t\t\t\t\t\t\t\t\t\t\t       ' width=' + size.width + ' height=' + size.height);\n\t\t\t\t\t} else {\n\t\t\t\t\t\twindow.postMobileMessage('insertfile name=' + aFile.name + ' type=' + type +\n\t\t\t\t\t\t\t\t\t\t\t       ' data=' + window.btoa(strBytes));\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t})(file);\n\t\t\treader.onerror = function(e) {\n\t\t\t\twindow.postMobileError('Error when reading file: ' + e);\n\t\t\t};\n\t\t\treader.onprogress = function(e) {\n\t\t\t\twindow.postMobileDebug('FileReader progress: ' + Math.round(e.loaded*100 / e.total) + '%');\n\t\t\t};\n\t\t\treader.readAsArrayBuffer(file);\n\t\t} else {\n\t\t\tvar xmlHttp = new XMLHttpRequest();\n\t\t\tthis._map.showBusy(_('Uploading...'), false);\n\t\t\txmlHttp.onreadystatechange = function () {\n\t\t\t\tif (xmlHttp.readyState === 4) {\n\t\t\t\t\tmap.hideBusy();\n\t\t\t\t\tif (xmlHttp.status === 200) {\n\t\t\t\t\t\tvar sectionName = L.CSections.ContentControl.name;\n\t\t\t\t\t\tvar section;\n\t\t\t\t\t\tif (sectionContainer.doesSectionExist(sectionName)) {\n\t\t\t\t\t\t\tsection = sectionContainer.getSectionWithName(sectionName);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (section && section.sectionProperties.picturePicker && type === 'graphic') {\n\t\t\t\t\t\t\tsocket.sendMessage('contentcontrolevent type=picture' + ' name=' + name);\n\t\t\t\t\t\t} else if (type === 'multimedia') {\n\t\t\t\t\t\t\tsocket.sendMessage('insertfile name=' + name + ' type=' + type + ' width=' + size.width + ' height=' + size.height);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tsocket.sendMessage('insertfile name=' + name + ' type=' + type);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse if (xmlHttp.status === 404) {\n\t\t\t\t\t\tmap.fire('error', {msg: errorMessages.uploadfile.notfound});\n\t\t\t\t\t}\n\t\t\t\t\telse if (xmlHttp.status === 413) {\n\t\t\t\t\t\tmap.fire('error', {msg: errorMessages.uploadfile.toolarge});\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tvar msg = _('Uploading file to server failed with status: {0}');\n\t\t\t\t\t\tmsg = msg.replace('{0}', xmlHttp.status);\n\t\t\t\t\t\tmap.fire('error', {msg: msg});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\t\t\txmlHttp.open('POST', url, true);\n\t\t\tvar formData = new FormData();\n\t\t\tformData.append('name', name);\n\t\t\tformData.append('childid', this._childId);\n\t\t\tif (file.filename && file.url) {\n\t\t\t\tformData.append('url', file.url);\n\t\t\t\tformData.append('filename', file.filename);\n\t\t\t} else {\n\t\t\t\tformData.append('file', file);\n\t\t\t}\n\t\t\txmlHttp.send(formData);\n\n\t\t\t// Set it to null in case server restarts/shuts down or the user reconnects after being idle\n\t\t\t// these change the childId but it would be cached already with the old one if a previous insertfile is made.\n\t\t\t// in that case we would get http error 400 because of the wrong childId.\n\t\t\t// when it's null we ask for a new childId before uploading.\n\t\t\tthis._childId = null;\n\t\t}\n\t},\n\n\t_sendURL: function (name, e) {\n\t\tvar sectionName = L.CSections.ContentControl.name;\n\t\tvar section;\n\t\tif (app.sectionContainer.doesSectionExist(sectionName)) {\n\t\t\tsection = app.sectionContainer.getSectionWithName(sectionName);\n\t\t}\n\n\t\tif (e.urltype == \"graphicurl\" && section && section.sectionProperties.picturePicker) {\n\t\t\t// The order argument is important\n\t\t\tapp.socket.sendMessage('contentcontrolevent type=pictureurl name=' + encodeURIComponent(e.url));\n\t\t} else {\n\t\t\tapp.socket.sendMessage('insertfile name=' + encodeURIComponent(e.url) + ' type=' + e.urltype);\n\t\t}\n\t}\n});\n\nL.Map.addInitHook('addHandler', 'fileInserter', L.Map.FileInserter);\n"]}