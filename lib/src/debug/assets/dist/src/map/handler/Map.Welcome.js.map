{"version":3,"file":"Map.Welcome.js","sourceRoot":"","sources":["../../../../../../../../../../../TanhX/online/browser/src/map/handler/Map.Welcome.js"],"names":[],"mappings":"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","sourcesContent":["/* -*- js-indent-level: 8 -*- */\n/*\n * Copyright the Collabora Online contributors.\n *\n * SPDX-License-Identifier: MPL-2.0\n *\n * This Source Code Form is subject to the terms of the Mozilla Public\n * License, v. 2.0. If a copy of the MPL was not distributed with this\n * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n */\n/*\n * L.Map.Welcome.\n */\n\n/* global app _ */\nL.Map.mergeOptions({\n\twelcome: true\n});\n\nL.Map.Welcome = L.Handler.extend({\n\n\t_getLocalWelcomeUrl: function () {\n\t\tvar welcomeLocation = app.LOUtil.getURL('/welcome/welcome.html');\n\t\tif (window.socketProxy)\n\t\t\twelcomeLocation = window.makeWsUrl(welcomeLocation);\n\t\treturn welcomeLocation;\n\t},\n\n\tinitialize: function (map) {\n\t\tL.Handler.prototype.initialize.call(this, map);\n\t\tthis._map.on('updateviewslist', this.onUpdateList, this);\n\n\t\t// temporarily use only local welcome dialog\n\t\tthis._url = /*window.welcomeUrl ? window.welcomeUrl:*/ this._getLocalWelcomeUrl();\n\t\tthis._retries = 2;\n\t\tthis._fallback = false;\n\t},\n\n\taddHooks: function () {\n\t\tL.DomEvent.on(window, 'message', this.onMessage, this);\n\t\tthis.remove();\n\t},\n\n\tisGuest: function () {\n\t\tvar docLayer = this._map._docLayer || {};\n\t\tvar viewInfo = this._map._viewInfo[docLayer._viewId];\n\t\treturn viewInfo && viewInfo.userextrainfo && viewInfo.userextrainfo.is_guest;\n\t},\n\n\tonUpdateList: function () {\n\t\tif (!this.isGuest() && window.autoShowWelcome && this.shouldWelcome()) {\n\t\t\tthis.showWelcomeDialog();\n\t\t}\n\t},\n\n\tshouldWelcome: function () {\n\t\tlet storedVersion = window.prefs.get('WSDWelcomeVersion');\n\t\tlet currentVersion = app.socket.WSDServer.Version;\n\t\tlet welcomeDisabledCookie = window.prefs.getBoolean('WSDWelcomeDisabled');\n\t\tlet welcomeDisabledDate = window.prefs.get('WSDWelcomeDisabledDate');\n\t\tif (welcomeDisabledDate)\n\t\t\twelcomeDisabledDate = welcomeDisabledDate.replaceAll('-', ' ');\n\t\tlet isWelcomeDisabled = false;\n\n\t\tif (welcomeDisabledCookie && welcomeDisabledDate) {\n\t\t\t// Check if we are still in the same day\n\t\t\tvar currentDate = new Date();\n\t\t\tif (welcomeDisabledDate === currentDate.toDateString())\n\t\t\t\tisWelcomeDisabled = true;\n\t\t\telse {\n\t\t\t\t//Values expired. Clear the local values\n\t\t\t\twindow.prefs.remove('WSDWelcomeDisabled');\n\t\t\t\twindow.prefs.remove('WSDWelcomeDisabledDate');\n\t\t\t}\n\t\t}\n\n\t\tif ((!storedVersion || storedVersion !== currentVersion) && !isWelcomeDisabled) {\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\tshowWelcomeDialog: function () {\n\t\tif (this._iframeWelcome && this._iframeWelcome.queryContainer())\n\t\t\tthis.remove();\n\n\t\tvar uiTheme = window.prefs.getBoolean('darkTheme') ? 'dark' : 'light';\n\t\tvar params = [{ 'ui_theme': uiTheme }];\n\n\t\tthis._iframeWelcome = L.iframeDialog(this._url, params, null, { prefix: 'iframe-welcome' });\n\t\tthis._iframeWelcome._iframe.title = _('Welcome Dialog');\n\t},\n\n\tremoveHooks: function () {\n\t\tL.DomEvent.off(window, 'message', this.onMessage, this);\n\t\tthis.remove();\n\t},\n\n\tremove: function () {\n\t\tif (this._iframeWelcome) {\n\t\t\tthis._iframeWelcome.remove();\n\t\t\tdelete this._iframeWelcome;\n\t\t}\n\t},\n\n\tonMessage: function (e) {\n\t\tif (typeof e.data !== 'string')\n\t\t\treturn; // Some extensions may inject scripts resulting in load events that are not strings\n\n\t\tif (e.data.startsWith('updatecheck-show'))\n\t\t\treturn;\n\n\t\tvar data = JSON.parse(e.data);\n\n\t\tif (data.MessageId === 'welcome-show') {\n\t\t\tthis._iframeWelcome.show();\n\t\t} else if (data.MessageId == 'welcome-translate') {\n\t\t\tthis._iframeWelcome.clearTimeout();\n\t\t\tvar keys = Object.keys(data.strings);\n\t\t\tfor (var it in keys) {\n\t\t\t\tdata.strings[keys[it]] = _(keys[it]).replace('{coolversion}', window.coolwsdVersion);\n\t\t\t}\n\t\t\tthis._iframeWelcome.postMessage(data);\n\t\t} else if (data.MessageId === 'welcome-close') {\n\t\t\twindow.prefs.set('WSDWelcomeVersion', app.socket.WSDServer.Version);\n\t\t\tthis.remove();\n\t\t} else if (data.MessageId == 'iframe-welcome-load' && !this._iframeWelcome.isVisible()) {\n\t\t\tif (this._retries-- > 0) {\n\t\t\t\tthis.remove();\n\t\t\t\tsetTimeout(L.bind(this.showWelcomeDialog, this), 200);\n\t\t\t} else if (this._fallback) {\n\t\t\t\tvar currentDate = new Date();\n\t\t\t\twindow.prefs.set('WSDWelcomeDisabled', true);\n\t\t\t\twindow.prefs.set('WSDWelcomeDisabledDate', currentDate.toDateString().replaceAll(' ', '-'));\n\t\t\t\tthis.remove();\n\t\t\t} else {\n\t\t\t\t// fallback\n\t\t\t\tthis._url = this._getLocalWelcomeUrl();\n\t\t\t\tthis._fallback = true;\n\t\t\t\tsetTimeout(L.bind(this.showWelcomeDialog, this), 200);\n\t\t\t}\n\t\t}\n\t}\n});\n\nif (!L.Browser.cypressTest && window.enableWelcomeMessage && window.prefs.canPersist) {\n\tL.Map.addInitHook('addHandler', 'welcome', L.Map.Welcome);\n}\n"]}