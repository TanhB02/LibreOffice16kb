{"version":3,"file":"OtherViewCursorSection.js","sourceRoot":"","sources":["../../../../../../../../../../../TanhX/online/browser/src/canvas/sections/OtherViewCursorSection.ts"],"names":[],"mappings":"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","sourcesContent":["/* -*- js-indent-level: 8 -*- */\n\n/*\n * Copyright the Collabora Online contributors.\n *\n * SPDX-License-Identifier: MPL-2.0\n *\n * This Source Code Form is subject to the terms of the Mozilla Public\n * License, v. 2.0. If a copy of the MPL was not distributed with this\n * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n */\n\n// This is used for other views' cursors.\n\nclass OtherViewCursorSection extends HTMLObjectSection {\n    documentObject: boolean = true;\n    interactable: boolean = false; // We don't bother with events.\n    zIndex: number = L.CSections.DefaultForDocumentObjects.processingOrder;\n    drawingOrder: number = L.CSections.DefaultForDocumentObjects.drawingOrder;\n    processingOrder: number = L.CSections.DefaultForDocumentObjects.processingOrder;\n\n    static sectionNamePrefix = 'OtherViewCursor ';\n    static sectionPointers: Array<OtherViewCursorSection> = [];\n\n    constructor(viewId: number, color: string, rectangle: cool.SimpleRectangle, part: number, mode: number) {\n        super(OtherViewCursorSection.sectionNamePrefix + viewId, rectangle.pWidth / app.dpiScale, rectangle.pHeight / app.dpiScale, new cool.SimplePoint(rectangle.x1, rectangle.y1));\n\n        this.sectionProperties.color = color;\n        this.sectionProperties.viewId = viewId;\n        this.sectionProperties.part = part;\n        this.sectionProperties.mode = mode;\n        this.sectionProperties.showCursor = true;\n        this.showSection = true;\n        this.getHTMLObject().style.backgroundColor = this.sectionProperties.color;\n    }\n\n    checkMyVisibility() {\n        let result = this.sectionProperties.showCursor && this.size[1] > 0;\n\n        if (result) {\n            if (!app.map._docLayer.isWriter()) {\n                if (this.sectionProperties.part !== app.map._docLayer._selectedPart || this.sectionProperties.mode !== app.map._docLayer._selectedMode)\n                    result = false;\n            }\n        }\n\n        if (result && app.file.textCursor.visible) {\n            const pos = [app.file.textCursor.rectangle.pX1, app.file.textCursor.rectangle.pY1];\n            if (this.position[0] === pos[0] && this.position[1] === pos[1])\n                result = false;\n        }\n\n        if (result && app.map.isViewReadOnly(this.sectionProperties.viewId))\n            result = false;\n\n        return result;\n    }\n\n    public static addOrUpdateOtherViewCursor(viewId: number, username: string, rectangleData: Array<string>, part: number, mode: number) {\n        let rectangle = new cool.SimpleRectangle(0, 0, 0, 0);\n        const color = app.LOUtil.rgbToHex(app.LOUtil.getViewIdColor(viewId));\n\n        if (rectangleData) {\n            rectangle = new app.definitions.simpleRectangle(rectangleData[0], rectangleData[1], rectangleData[2], rectangleData[3]);\n        }\n\n        rectangle.pWidth = 2 * app.dpiScale; // Width of the cursor.\n\n        const sectionName = OtherViewCursorSection.sectionNamePrefix + viewId;\n        let section: OtherViewCursorSection;\n        if (app.sectionContainer.doesSectionExist(sectionName)) {\n            section = app.sectionContainer.getSectionWithName(sectionName) as OtherViewCursorSection;\n            section.sectionProperties.part = part;\n            section.sectionProperties.mode = mode;\n            section.size[0] = rectangle.pWidth;\n            section.size[1] = rectangle.pHeight;\n\n            section.getHTMLObject().style.width = (section.size[0] / app.dpiScale) + 'px';\n            section.getHTMLObject().style.height = (section.size[1] / app.dpiScale) + 'px';\n\n            section.setPosition(rectangle.pX1, rectangle.pY1);\n        }\n        else {\n            section = new OtherViewCursorSection(viewId, color, rectangle, part, mode);\n            app.sectionContainer.addSection(section);\n            OtherViewCursorSection.sectionPointers.push(section);\n        }\n\n        section.setShowSection(section.checkMyVisibility());\n        section.onNewDocumentTopLeft();\n        section.adjustHTMLObjectPosition();\n        const documentPosition = new cool.SimplePoint(section.position[0] * app.pixelsToTwips, (section.position[1] - 20) * app.pixelsToTwips);\n\n        if (section.showSection && section.isVisible)\n            app.definitions.cursorHeaderSection.showCursorHeader(viewId, username, documentPosition, color);\n\n        app.sectionContainer.requestReDraw();\n    }\n\n    public static removeView(viewId: number) {\n        const sectionName = OtherViewCursorSection.sectionNamePrefix + viewId;\n        if (app.sectionContainer.doesSectionExist(sectionName)) {\n            const section = app.sectionContainer.getSectionWithName(sectionName) as OtherViewCursorSection;\n            OtherViewCursorSection.sectionPointers.splice(OtherViewCursorSection.sectionPointers.indexOf(section), 1);\n            app.sectionContainer.removeSection(sectionName);\n            app.sectionContainer.requestReDraw();\n        }\n    }\n\n    public static doesViewCursorSectionExist(viewId: number) {\n        const name = OtherViewCursorSection.sectionNamePrefix + viewId;\n        return app.sectionContainer.doesSectionExist(name);\n    }\n\n    public static getViewCursorSection(viewId: number) {\n        if (OtherViewCursorSection.doesViewCursorSectionExist(viewId)) {\n            const name = OtherViewCursorSection.sectionNamePrefix + viewId;\n            return app.sectionContainer.getSectionWithName(name);\n        }\n        else\n            return null;\n    }\n\n    public static updateVisibilities(hideCursors: boolean = false) {\n        for (let i = 0; i < OtherViewCursorSection.sectionPointers.length; i++) {\n            const section = OtherViewCursorSection.sectionPointers[i];\n            section.setShowSection(section.checkMyVisibility());\n            if (hideCursors)\n                section.getHTMLObject().style.opacity = '0';\n            else\n                section.getHTMLObject().style.opacity = '1';\n        }\n        app.sectionContainer.requestReDraw();\n    }\n}\n\napp.definitions.otherViewCursorSection = OtherViewCursorSection;\n"]}