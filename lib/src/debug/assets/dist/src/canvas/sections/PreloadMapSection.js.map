{"version":3,"file":"PreloadMapSection.js","sourceRoot":"","sources":["../../../../../../../../../../../TanhX/online/browser/src/canvas/sections/PreloadMapSection.ts"],"names":[],"mappings":"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","sourcesContent":["/* global Proxy _ */\n/*\n * Copyright the Collabora Online contributors.\n *\n * SPDX-License-Identifier: MPL-2.0\n *\n * This Source Code Form is subject to the terms of the Mozilla Public\n * License, v. 2.0. If a copy of the MPL was not distributed with this\n * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n */\n\nclass PreloadMapSection extends app.definitions.canvasSectionObject {\n\tname: string = L.CSections.Debug.PreloadMap.name;\n\tinteractable: boolean = false;\n\tanchor: string[] = ['top', 'left'];\n\tprocessingOrder: number = L.CSections.Debug.PreloadMap.processingOrder;\n\tdrawingOrder: number = L.CSections.Debug.PreloadMap.drawingOrder;\n\tzIndex: number = L.CSections.Debug.PreloadMap.zIndex;\n\tboundToSection: string = 'tiles';\n\n\tconstructor() {\n\t\tsuper();\n\t\tthis._map = L.Map.THIS;\n\t}\n\n\tonDraw(\n\t\tframeCount?: number,\n\t\telapsedTime?: number,\n\t\tsubsetBounds?: Bounds,\n\t): void {\n\t\tvar docLayer = this._map._docLayer;\n\t\tvar ctx = docLayer._painter._paintContext();\n\n\t\tvar zoom = Math.round(this._map.getZoom());\n\t\tvar part = docLayer._selectedPart;\n\t\tvar tileRanges = ctx.paneBoundsList.map(\n\t\t\tTileManager.pxBoundsToTileRange,\n\t\t\tTileManager,\n\t\t);\n\n\t\t// Get the 'main' view\n\t\tvar viewRange = tileRanges.length == 4 ? tileRanges[3] : tileRanges[0];\n\n\t\tvar canvas = this.context;\n\n\t\tvar tileRange = new L.Bounds(viewRange.min, viewRange.max);\n\n\t\t// stop annoying jitter as the view fits different numbers of tiles.\n\t\tvar viewWidth = Math.floor(\n\t\t\t(this._map.getPixelBoundsCore().getSize().x + TileManager.tileSize - 1) /\n\t\t\t\tTileManager.tileSize,\n\t\t);\n\t\tvar viewHeight = Math.floor(\n\t\t\t(this._map.getPixelBoundsCore().getSize().y + TileManager.tileSize - 1) /\n\t\t\t\tTileManager.tileSize,\n\t\t);\n\n\t\t// writer defaults\n\t\tvar sizePix: number = 3;\n\t\tvar numParts = 1;\n\t\tvar enlargeX = 0.1;\n\t\tvar enlargeY = 2;\n\t\tvar mainYMultiply = 10.0;\n\t\tif (docLayer.isCalc()) {\n\t\t\tenlargeX = 2;\n\t\t\tenlargeY = 2;\n\t\t\tsizePix = 6;\n\t\t\tnumParts = 3;\n\t\t\tmainYMultiply = 2;\n\t\t} else if (docLayer.isImpress()) {\n\t\t\tenlargeX = 0.5;\n\t\t\tenlargeY = 0.5;\n\t\t\tmainYMultiply = 0;\n\t\t\tsizePix = 6;\n\t\t\tnumParts = 7;\n\t\t}\n\n\t\t// Enlarge in each dimension\n\t\ttileRange.min.x = tileRange.min.x - Math.floor(viewWidth * enlargeX);\n\t\ttileRange.max.x = tileRange.max.x + Math.floor(viewWidth * enlargeX);\n\t\ttileRange.min.y = tileRange.min.y - Math.floor(viewHeight * enlargeY);\n\t\ttileRange.max.y = tileRange.max.y + Math.floor(viewHeight * enlargeY);\n\n\t\tvar preParts = (numParts - 1) / 2;\n\t\tvar partBounds = new Array(numParts);\n\t\tfor (var i = 0; i < partBounds.length; ++i) {\n\t\t\tpartBounds[i] = new L.Bounds(tileRange.min, tileRange.max);\n\t\t\tpartBounds[i].part = part + i - preParts;\n\t\t}\n\n\t\t// current view should be bigger vertically at least\n\t\tpartBounds[preParts].min.y -= viewHeight * mainYMultiply;\n\t\tpartBounds[preParts].max.y += viewHeight * mainYMultiply;\n\n\t\tvar offx: number = 50;\n\t\tvar offy: number = 200;\n\t\tvar voffset: number = 0;\n\t\tfor (var p = 0; p < partBounds.length; ++p) {\n\t\t\tvar range = partBounds[p];\n\t\t\tfor (var j = range.min.y; j <= range.max.y; ++j) {\n\t\t\t\tfor (var i: number = range.min.x; i <= range.max.x; ++i) {\n\t\t\t\t\tif (i >= 0 && j >= 0 && range.part >= 0) {\n\t\t\t\t\t\tvar coords = new TileCoordData(\n\t\t\t\t\t\t\ti * TileManager.tileSize,\n\t\t\t\t\t\t\tj * TileManager.tileSize,\n\t\t\t\t\t\t\tzoom,\n\t\t\t\t\t\t\trange.part,\n\t\t\t\t\t\t\tdocLayer._selectedMode,\n\t\t\t\t\t\t);\n\t\t\t\t\t\tvar key = coords.key();\n\t\t\t\t\t\tconst tile: Tile = TileManager.get(key);\n\n\t\t\t\t\t\tif (!tile)\n\t\t\t\t\t\t\tcanvas.fillStyle = 'rgba(128, 128, 128, 0.5)'; // grey\n\t\t\t\t\t\t// state of the tile\n\t\t\t\t\t\telse if (!tile.hasContent())\n\t\t\t\t\t\t\tcanvas.fillStyle = 'rgba(255, 0, 0, 0.8)'; // red\n\t\t\t\t\t\telse if (tile.needsFetch())\n\t\t\t\t\t\t\tcanvas.fillStyle = 'rgba(255, 255, 0, 0.8)'; // yellow\n\t\t\t\t\t\telse if (!tile.image)\n\t\t\t\t\t\t\tcanvas.fillStyle = 'rgba(0, 96, 0, 0.8)'; // dark green\n\t\t\t\t\t\telse if (tile.distanceFromView <= 0)\n\t\t\t\t\t\t\tcanvas.fillStyle = 'rgba(0, 255, 0, 0.5)'; // visible\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tconst expFactor = TileManager.getExpiryFactor(tile);\n\t\t\t\t\t\t\tif (expFactor >= 0)\n\t\t\t\t\t\t\t\t// expiry shown by more blue, and less green\n\t\t\t\t\t\t\t\tcanvas.fillStyle =\n\t\t\t\t\t\t\t\t\t'rgba(0, ' +\n\t\t\t\t\t\t\t\t\tMath.round(192 * (1.0 - expFactor)) +\n\t\t\t\t\t\t\t\t\t', ' +\n\t\t\t\t\t\t\t\t\tMath.round(96 * expFactor) +\n\t\t\t\t\t\t\t\t\t', 0.8)';\n\t\t\t\t\t\t}\n\t\t\t\t\t} // outside document range\n\t\t\t\t\telse canvas.fillStyle = 'rgba(0, 0, 0, 0.3)'; // dark grey\n\n\t\t\t\t\tcanvas.fillRect(\n\t\t\t\t\t\toffx + (i - range.min.x) * sizePix,\n\t\t\t\t\t\toffy + (j - range.min.y) * sizePix + voffset,\n\t\t\t\t\t\tsizePix,\n\t\t\t\t\t\tsizePix,\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\t\t\t// view rectangle\n\t\t\tif (range.part == part) {\n\t\t\t\t// viewport in tiles - not that accurate.\n\t\t\t\tcanvas.strokeStyle = 'rgba(0, 0, 0, 0.5)';\n\t\t\t\tcanvas.lineWidth = 1.0;\n\t\t\t\tcanvas.strokeRect(\n\t\t\t\t\toffx + (viewRange.min.x - range.min.x) * sizePix,\n\t\t\t\t\toffy + (viewRange.min.y - range.min.y) * sizePix + voffset,\n\t\t\t\t\tviewWidth * sizePix,\n\t\t\t\t\tviewHeight * sizePix,\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tvoffset += sizePix * (range.max.y - range.min.y + 4);\n\t\t}\n\t}\n}\n\napp.definitions.preloadMapSection = PreloadMapSection;\n"]}