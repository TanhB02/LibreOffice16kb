{"version":3,"file":"Canvas.js","sourceRoot":"","sources":["../../../../../../../../../../../TanhX/online/browser/src/layer/vector/Canvas.js"],"names":[],"mappings":"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","sourcesContent":["/* -*- js-indent-level: 8 -*- */\n/* global app */\n/*\n * L.Canvas handles Canvas vector layers rendering and mouse events handling. All Canvas-specific code goes here.\n */\n\nL.Canvas = L.Renderer.extend({\n\n\tonAdd: function () {\n\t\tL.Renderer.prototype.onAdd.call(this);\n\n\t\tthis._layers = this._layers || {};\n\n\t\t// redraw vectors since canvas is cleared upon removal\n\t\tthis._draw();\n\t},\n\n\t_initContainer: function () {\n\t\tvar container = this._container = document.createElement('canvas');\n\n\t\tL.DomEvent\n\t\t\t.on(container, 'mousemove', this._onMouseMove, this)\n\t\t\t.on(container, 'click dblclick mousedown mouseup contextmenu', this._onClick, this);\n\n\t\tthis._ctx = container.getContext('2d');\n\t},\n\n\t_update: function () {\n\t\tL.Renderer.prototype._update.call(this);\n\n\t\tvar b = this._bounds,\n\t\t    container = this._container,\n\t\t    size = b.getSize(),\n\t\t    m = window.app.dpiScale;\n\n\t\tL.DomUtil.setPosition(container, b.min);\n\n\t\t// set canvas size (also clearing it); use double size on retina\n\t\tcontainer.width = m * size.x;\n\t\tcontainer.height = m * size.y;\n\t\tcontainer.style.width = size.x + 'px';\n\t\tcontainer.style.height = size.y + 'px';\n\n\t\tthis._ctx.scale(m, m);\n\n\t\t// translate so we use the same path coordinates after canvas element moves\n\t\tthis._ctx.translate(-b.min.x, -b.min.y);\n\t},\n\n\t_initPath: function (layer) {\n\t\tthis._layers[app.util.stamp(layer)] = layer;\n\t},\n\n\t_addPath: app.util.falseFn,\n\n\t_removePath: function (layer) {\n\t\tlayer._removed = true;\n\t\tthis._requestRedraw(layer);\n\t},\n\n\t_updatePath: function (layer) {\n\t\tthis._redrawBounds = layer._pxBounds;\n\t\tthis._draw(true);\n\t\tlayer._project();\n\t\tlayer._update();\n\t\tthis._draw();\n\t\tthis._redrawBounds = null;\n\t},\n\n\t_updateStyle: function (layer) {\n\t\tthis._requestRedraw(layer);\n\t},\n\n\t_requestRedraw: function (layer) {\n\t\tif (!this._map) { return; }\n\n\t\tthis._redrawBounds = this._redrawBounds || new L.Bounds();\n\t\tthis._redrawBounds.extend(layer._pxBounds.min).extend(layer._pxBounds.max);\n\n\t\tthis._redrawRequest = this._redrawRequest || app.util.requestAnimFrame(this._redraw, this);\n\t},\n\n\t_redraw: function () {\n\t\tthis._redrawRequest = null;\n\n\t\tthis._draw(true); // clear layers in redraw bounds\n\t\tthis._draw(); // draw layers\n\n\t\tthis._redrawBounds = null;\n\t},\n\n\t_draw: function (clear) {\n\t\tthis._clear = clear;\n\t\tvar layer;\n\n\t\tfor (var id in this._layers) {\n\t\t\tlayer = this._layers[id];\n\t\t\tif (!this._redrawBounds || layer._pxBounds.intersects(this._redrawBounds)) {\n\t\t\t\tlayer._updatePath();\n\t\t\t}\n\t\t\tif (clear && layer._removed) {\n\t\t\t\tdelete layer._removed;\n\t\t\t\tdelete this._layers[id];\n\t\t\t}\n\t\t}\n\t},\n\n\t_updatePoly: function (layer, closed) {\n\n\t\tvar i, j, len2, p,\n\t\t    parts = layer._parts,\n\t\t    len = parts.length,\n\t\t    ctx = this._ctx;\n\n\t\tif (!len) { return; }\n\n\t\tctx.beginPath();\n\n\t\tfor (i = 0; i < len; i++) {\n\t\t\tfor (j = 0, len2 = parts[i].length; j < len2; j++) {\n\t\t\t\tp = parts[i][j];\n\t\t\t\tctx[j ? 'lineTo' : 'moveTo'](p.x, p.y);\n\t\t\t}\n\t\t\tif (closed) {\n\t\t\t\tctx.closePath();\n\t\t\t}\n\t\t}\n\n\t\tthis._fillStroke(ctx, layer);\n\n\t\t// TODO optimization: 1 fill/stroke for all features with equal style instead of 1 for each feature\n\t},\n\n\t_updateCircle: function (layer) {\n\n\t\tif (layer._empty()) { return; }\n\n\t\tvar p = layer._point,\n\t\t    ctx = this._ctx,\n\t\t    r = layer._radius,\n\t\t    s = (layer._radiusY || r) / r;\n\n\t\tif (s !== 1) {\n\t\t\tctx.save();\n\t\t\tctx.scale(1, s);\n\t\t}\n\n\t\tctx.beginPath();\n\t\tctx.arc(p.x, p.y / s, r, 0, Math.PI * 2, false);\n\n\t\tif (s !== 1) {\n\t\t\tctx.restore();\n\t\t}\n\n\t\tthis._fillStroke(ctx, layer);\n\t},\n\n\t_fillStroke: function (ctx, layer) {\n\t\tvar clear = this._clear,\n\t\t    options = layer.options;\n\n\t\tctx.globalCompositeOperation = clear ? 'destination-out' : 'source-over';\n\n\t\tif (options.fill) {\n\t\t\tctx.globalAlpha = clear ? 1 : options.fillOpacity;\n\t\t\tctx.fillStyle = options.fillColor || options.color;\n\t\t\tctx.fill(options.fillRule || 'evenodd');\n\t\t}\n\n\t\tif (options.stroke && options.weight !== 0) {\n\t\t\tctx.globalAlpha = clear ? 1 : options.opacity;\n\n\t\t\t// if clearing shape, do it with the previously drawn line width\n\t\t\tlayer._prevWeight = ctx.lineWidth = clear ? layer._prevWeight + 1 : options.weight;\n\n\t\t\tctx.strokeStyle = options.color;\n\t\t\tctx.lineCap = options.lineCap;\n\t\t\tctx.lineJoin = options.lineJoin;\n\t\t\tctx.stroke();\n\t\t}\n\t},\n\n\t// Canvas obviously doesn't have mouse events for individual drawn objects,\n\t// so we emulate that by calculating what's under the mouse on mousemove/click manually\n\n\t_onClick: function (e) {\n\t\tvar point = this._map.mouseEventToLayerPoint(e);\n\n\t\tfor (var id in this._layers) {\n\t\t\tif (this._layers[id]._containsPoint(point)) {\n\t\t\t\tL.DomEvent._fakeStop(e);\n\t\t\t\tthis._fireEvent(this._layers[id], e);\n\t\t\t}\n\t\t}\n\t},\n\n\t_onMouseMove: function (e) {\n\t\tif (!this._map) { return; }\n\n\t\tvar point = this._map.mouseEventToLayerPoint(e);\n\n\t\t// TODO don't do on each move event, throttle since it's expensive\n\t\tfor (var id in this._layers) {\n\t\t\tthis._handleHover(this._layers[id], e, point);\n\t\t}\n\t},\n\n\t_handleHover: function (layer, e, point) {\n\t\tif (!layer.options.interactive) { return; }\n\n\t\tif (layer._containsPoint(point)) {\n\t\t\t// if we just got inside the layer, fire mouseover\n\t\t\tif (!layer._mouseInside) {\n\t\t\t\tL.DomUtil.addClass(this._container, 'leaflet-interactive'); // change cursor\n\t\t\t\tthis._fireEvent(layer, e, 'mouseover');\n\t\t\t\tlayer._mouseInside = true;\n\t\t\t}\n\t\t\t// fire mousemove\n\t\t\tthis._fireEvent(layer, e);\n\n\t\t} else if (layer._mouseInside) {\n\t\t\t// if we're leaving the layer, fire mouseout\n\t\t\tL.DomUtil.removeClass(this._container, 'leaflet-interactive');\n\t\t\tthis._fireEvent(layer, e, 'mouseout');\n\t\t\tlayer._mouseInside = false;\n\t\t}\n\t},\n\n\t_fireEvent: function (layer, e, type) {\n\t\tthis._map._fireDOMEvent(layer, e, type || e.type);\n\t},\n\n\t// TODO _bringToFront & _bringToBack, pretty tricky\n\n\t_bringToFront: app.util.falseFn,\n\t_bringToBack: app.util.falseFn\n});\n\nL.Browser.canvas = (function () {\n\treturn !!document.createElement('canvas').getContext;\n}());\n\nL.canvas = function (options) {\n\treturn L.Browser.canvas ? new L.Canvas(options) : null;\n};\n\nL.Polyline.prototype._containsPoint = function (p, closed) {\n\tvar i, j, k, len, len2, part,\n\t    w = this._clickTolerance();\n\n\tif (!this._pxBounds.contains(p)) { return false; }\n\n\t// hit detection for polylines\n\tfor (i = 0, len = this._parts.length; i < len; i++) {\n\t\tpart = this._parts[i];\n\n\t\tfor (j = 0, len2 = part.length, k = len2 - 1; j < len2; k = j++) {\n\t\t\tif (!closed && (j === 0)) { continue; }\n\n\t\t\tif (L.LineUtil.pointToSegmentDistance(p, part[k], part[j]) <= w) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t}\n\treturn false;\n};\n\nL.Polygon.prototype._containsPoint = function (p) {\n\tvar inside = false,\n\t    part, p1, p2, i, j, k, len, len2;\n\n\tif (!this._pxBounds.contains(p)) { return false; }\n\n\t// ray casting algorithm for detecting if point is in polygon\n\tfor (i = 0, len = this._parts.length; i < len; i++) {\n\t\tpart = this._parts[i];\n\n\t\tfor (j = 0, len2 = part.length, k = len2 - 1; j < len2; k = j++) {\n\t\t\tp1 = part[j];\n\t\t\tp2 = part[k];\n\n\t\t\tif (((p1.y > p.y) !== (p2.y > p.y)) && (p.x < (p2.x - p1.x) * (p.y - p1.y) / (p2.y - p1.y) + p1.x)) {\n\t\t\t\tinside = !inside;\n\t\t\t}\n\t\t}\n\t}\n\n\t// also check if it's on polygon stroke\n\treturn inside || L.Polyline.prototype._containsPoint.call(this, p, true);\n};\n"]}