{"version":3,"file":"WriterTileLayer.js","sourceRoot":"","sources":["../../../../../../../../../../../TanhX/online/browser/src/layer/tile/WriterTileLayer.js"],"names":[],"mappings":"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","sourcesContent":["/* -*- js-indent-level: 8 -*- */\n/*\n * Copyright the Collabora Online contributors.\n *\n * SPDX-License-Identifier: MPL-2.0\n *\n * This Source Code Form is subject to the terms of the Mozilla Public\n * License, v. 2.0. If a copy of the MPL was not distributed with this\n * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n */\n/*\n * Writer tile layer is used to display a text document\n */\n\n/* global app GraphicSelection cool TileManager */\nL.WriterTileLayer = L.CanvasTileLayer.extend({\n\n\tnewAnnotation: function (commentData) {\n\t\tconst comment = new cool.Comment(commentData, {}, app.sectionContainer.getSectionWithName(L.CSections.CommentList.name));\n\n\t\tif (app.file.textCursor.visible) {\n\t\t\tcomment.sectionProperties.data.anchorPos = [app.file.textCursor.rectangle.x2, app.file.textCursor.rectangle.y1];\n\t\t} else if (GraphicSelection.hasActiveSelection()) {\n\t\t\t// An image is selected, then guess the anchor based on the graphic selection.\n\t\t\tcomment.sectionProperties.data.anchorPos = [GraphicSelection.rectangle.x1, GraphicSelection.rectangle.y2];\n\t\t}\n\n\t\tapp.sectionContainer.getSectionWithName(L.CSections.CommentList.name).add(comment);\n\t\tapp.sectionContainer.getSectionWithName(L.CSections.CommentList.name).modify(comment);\n\t},\n\n\tbeforeAdd: function (map) {\n\t\tmap.uiManager.initializeSpecializedUI('text');\n\t},\n\n\t_onCommandValuesMsg: function (textMsg) {\n\t\tvar braceIndex = textMsg.indexOf('{');\n\t\tif (braceIndex < 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar values = JSON.parse(textMsg.substring(braceIndex));\n\t\tif (!values) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (values.comments) {\n\t\t\tvalues.comments.forEach(function(comment) {\n\t\t\t\tcomment.id = comment.id.toString();\n\t\t\t\tcomment.parent = comment.parentId.toString();\n\t\t\t});\n\t\t\tapp.sectionContainer.getSectionWithName(L.CSections.CommentList.name).importComments(values.comments);\n\t\t}\n\t\telse if (values.redlines && values.redlines.length > 0) {\n\t\t\tapp.sectionContainer.getSectionWithName(L.CSections.CommentList.name).importChanges(values.redlines);\n\t\t}\n\t\telse if (this._map.zotero && values.userDefinedProperties) {\n\t\t\tthis._map.zotero.handleCustomProperty(values.userDefinedProperties);\n\t\t}\n\t\telse if (this._map.zotero && values.fields) {\n\t\t\tthis._map.zotero.onFieldValue(values.fields);\n\t\t} else if (this._map.zotero && values.field) {\n\t\t\tthis._map.zotero.handleFieldUnderCursor(values.field);\n\t\t} else if (this._map.zotero && values.setRefs) {\n\t\t\tthis._map.zotero.onFieldValue(values.setRefs);\n\t\t} else if (this._map.zotero && values.setRef) {\n\t\t\tthis._map.zotero.handleFieldUnderCursor(values.setRef);\n\t\t} else if (this._map.zotero && values.bookmarks) {\n\t\t\tthis._map.zotero.handleBookmark(values.bookmarks);\n\t\t} else if (this._map.zotero && values.bookmark) {\n\t\t\tthis._map.zotero.fetchCustomProperty(values.bookmark.name);\n\t\t} else if (this._map.zotero && values.sections) {\n\t\t\tthis._map.zotero.onFieldValue(values.sections);\n\t\t} else {\n\t\t\tL.CanvasTileLayer.prototype._onCommandValuesMsg.call(this, textMsg);\n\t\t}\n\t},\n\n\t_onSetPartMsg: function (textMsg) {\n\t\tvar part = parseInt(textMsg.match(/\\d+/g)[0]);\n\t\tif (part !== this._currentPage) {\n\t\t\tthis._currentPage = part;\n\t\t\tthis._map.fire('pagenumberchanged', {\n\t\t\t\tcurrentPage: part,\n\t\t\t\tpages: this._pages,\n\t\t\t\tdocType: this._docType\n\t\t\t});\n\t\t}\n\t},\n\n\t_onStatusMsg: function (textMsg) {\n\t\tconst statusJSON = JSON.parse(textMsg.replace('status:', '').replace('statusupdate:', ''));\n\n\t\tif (app.socket._reconnecting) {\n\t\t\t// persist cursor position on reconnection\n\t\t\t// In writer, core always sends the cursor coordinates\n\t\t\t// of the first paragraph of the document so we want to ignore that\n\t\t\t// to eliminate document jumping while reconnecting\n\t\t\tthis.persistCursorPositionInWriter = true;\n\t\t\tthis._postMouseEvent('buttondown', this.lastCursorPos.center[0], this.lastCursorPos.center[1], 1, 1, 0);\n\t\t\tthis._postMouseEvent('buttonup', this.lastCursorPos.center[0], this.lastCursorPos.center[1], 1, 1, 0);\n\t\t}\n\t\tif (!statusJSON.width || !statusJSON.height || this._documentInfo === textMsg)\n\t\t\treturn;\n\n\t\tvar sizeChanged = statusJSON.width !== app.file.size.x || statusJSON.height !== app.file.size.y;\n\n\t\tif (statusJSON.viewid !== undefined) this._viewId = statusJSON.viewid;\n\n\t\tconsole.assert(this._viewId >= 0, 'Incorrect viewId received: ' + this._viewId);\n\n\t\tif (sizeChanged) {\n\t\t\tapp.file.size.x = statusJSON.width;\n\t\t\tapp.file.size.y = statusJSON.height;\n\t\t\tapp.view.size = app.file.size.clone();\n\t\t\tthis._docType = statusJSON.type;\n\t\t\tthis._updateMaxBounds(true);\n\t\t}\n\n\t\tthis._documentInfo = textMsg;\n\t\tthis._selectedPart = 0;\n\t\tthis._selectedMode = (statusJSON.mode !== undefined) ? statusJSON.mode : 0;\n\t\tthis._parts = 1;\n\t\tthis._currentPage = statusJSON.selectedpart;\n\t\tthis._pages = statusJSON.partscount;\n\t\tapp.file.writer.pageRectangleList = statusJSON.pagerectangles.slice(); // Copy the array.\n\t\tthis._map.fire('pagenumberchanged', {\n\t\t\tcurrentPage: this._currentPage,\n\t\t\tpages: this._pages,\n\t\t\tdocType: this._docType\n\t\t});\n\t\tTileManager.resetPreFetching(true);\n\t},\n});\n"]}