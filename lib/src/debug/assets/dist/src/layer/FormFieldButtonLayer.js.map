{"version":3,"file":"FormFieldButtonLayer.js","sourceRoot":"","sources":["../../../../../../../../../../TanhX/online/browser/src/layer/FormFieldButtonLayer.js"],"names":[],"mappings":"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","sourcesContent":["/* -*- js-indent-level: 8 -*- */\n/*\n * Copyright the Collabora Online contributors.\n *\n * SPDX-License-Identifier: MPL-2.0\n *\n * This Source Code Form is subject to the terms of the Mozilla Public\n * License, v. 2.0. If a copy of the MPL was not distributed with this\n * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n */\n/*\n * L.FormFieldButton is used to interact with text based form fields.\n */\n/* global _ app $ */\nL.FormFieldButton = L.Layer.extend({\n\n\toptions: {\n\t\tpane: 'formfieldPane'\n\t},\n\n\tinitialize: function (data) {\n\n\t\tL.Layer.prototype.initialize.call(this);\n\n\t\twindow.app.console.assert(data.type === 'drop-down');\n\t\tthis._buttonData = data;\n\t},\n\n\tonAdd: function (map) {\n\t\tthis.map = map;\n\t\tthis._clearButton();\n\t\tthis._buildFormButton(map);\n\t},\n\n\t_buildFormButton: function(map) {\n\t\t// We use a container to have the frame and the drop-down button the same height\n\t\tvar container = L.DomUtil.create('div', 'form-field-button-container', this.getPane('formfieldPane'));\n\n\t\t// Calculate button area in layer point unot\n\t\tvar buttonArea = this._calculateButtonArea(map);\n\n\t\t// Build the frame around the text area\n\t\tvar frameData = this._buildButtonFrame(container, buttonArea);\n\t\tvar framePos = frameData[0];\n\t\tvar frameWidth = frameData[1];\n\t\tvar frameHeight = frameData[2];\n\n\t\t// We set the shared height here.\n\t\tcontainer.style.height = frameHeight + 'px';\n\n\t\t// Add a drop down button to open the list\n\t\tthis._buildDropDownButton(container, framePos, frameWidth);\n\n\t\t// Build list of items opened by clicking on the drop down button\n\t\tthis._buildDropDownList(framePos, frameWidth, frameHeight);\n\n\t\tmap.on('zoomstart', this._onZoomStart, this);\n\t\tmap.on('zoomend', this._onZoomEnd, this);\n\t},\n\n\t_calculateButtonArea: function(map) {\n\t\t// First get the data from the message in twips.\n\t\tvar strTwips = this._buttonData.textArea.match(/\\d+/g);\n\t\tvar topLeftTwips = new L.Point(parseInt(strTwips[0]), parseInt(strTwips[1]));\n\t\tvar offset = new L.Point(parseInt(strTwips[2]), parseInt(strTwips[3]));\n\t\tvar bottomRightTwips = topLeftTwips.add(offset);\n\t\tvar buttonAreaTwips = [topLeftTwips, bottomRightTwips];\n\n\t\t// Then convert to unit which can be used on the layer.\n\t\tvar buttonAreaLatLng = new L.LatLngBounds(\n\t\t\tmap._docLayer._twipsToLatLng(buttonAreaTwips[0], this._map.getZoom()),\n\t\t\tmap._docLayer._twipsToLatLng(buttonAreaTwips[1], this._map.getZoom()));\n\n\t\tvar buttonAreaLayer = new L.Bounds(\n\t\t\tmap.latLngToLayerPoint(buttonAreaLatLng.getNorthWest()),\n\t\t\tmap.latLngToLayerPoint(buttonAreaLatLng.getSouthEast()));\n\n\t\treturn buttonAreaLayer;\n\t},\n\n\t_buildButtonFrame: function(container, buttonArea) {\n\t\t// Create a frame around the text area\n\t\tvar buttonFrame = L.DomUtil.create('div', 'form-field-frame', container);\n\n\t\t// Use a small padding between the text and the frame\n\t\tvar extraPadding = 2;\n\t\tvar size = buttonArea.getSize();\n\t\tvar frameWidth = size.x + 1.5 * extraPadding;\n\t\tvar frameHeight = size.y + 1.5 * extraPadding;\n\t\tbuttonFrame.style.width = frameWidth + 'px';\n\n\t\tvar framePos = new L.Point(buttonArea.min.x - extraPadding, buttonArea.min.y - extraPadding);\n\t\tL.DomUtil.setPosition(buttonFrame, framePos);\n\n\t\treturn [framePos, frameWidth, frameHeight];\n\t},\n\n\t_buildDropDownButton: function(container, framePos, frameWidth) {\n\t\tvar button = L.DomUtil.create('button', 'form-field-button', container);\n\t\tvar buttonPos = new L.Point(framePos.x + frameWidth, framePos.y);\n\t\tL.DomUtil.setPosition(button, buttonPos);\n\t\tbutton.style.width = container.style.height;\n\n\t\tvar image = L.DomUtil.create('img', 'form-field-button-image', button);\n\t\timage.setAttribute('alt', _('Unfold'));\n\t\tapp.LOUtil.setImage(image, 'unfold.svg', this.map);\n\t\tbutton.addEventListener('click', this._onClickDropDown);\n\n\t\t// Stop propagation to the main document\n\t\tbutton.addEventListener('mouseup', function(event) {event.stopPropagation();});\n\t\tbutton.addEventListener('mousedown', function(event) {event.stopPropagation();});\n\t},\n\n\t_buildDropDownList: function(framePos, frameWidth, frameHeight) {\n\t\tvar dropDownList = L.DomUtil.create('div', 'drop-down-field-list', this.getPane('formfieldPane'));\n\t\t$('.drop-down-field-list').hide();\n\t\tL.DomUtil.setPosition(dropDownList, framePos);\n\t\tdropDownList.style.minWidth = (frameWidth + frameHeight) + 'px';\n\n\t\tvar itemList = this._buttonData.params.items;\n\t\tvar selected = parseInt(this._buttonData.params.selected);\n\n\t\tfor (var i = 0; i < itemList.length; ++i) {\n\t\t\tthis._buildListItem(dropDownList, itemList[i], frameHeight, i === selected);\n\t\t}\n\n\t\tif (this._buttonData.params.items.length === 0) {\n\t\t\tthis._buildListItem(dropDownList, this._buttonData.params.placeholderText, frameHeight, false);\n\t\t}\n\t},\n\n\t_buildListItem: function(parent, text, frameHeight, selected) {\n\t\tvar option = L.DomUtil.create('div', 'drop-down-field-list-item', parent);\n\t\toption.innerHTML = text;\n\t\toption.style.fontSize = frameHeight * 0.7 + 'px';\n\n\t\toption.addEventListener('click', this._onListItemSelect);\n\t\toption.map = this.map;\n\t\toption._buttonData = this._buttonData;\n\n\t\t// Stop propagation to the main document\n\t\toption.addEventListener('mouseup', function(event) {event.stopPropagation();});\n\t\toption.addEventListener('mousedown', function(event) {event.stopPropagation();});\n\n\t\tif (selected === true)\n\t\t\toption.classList.add('selected');\n\t},\n\n\tonRemove: function () {\n\t\tthis._clearButton();\n\t\tthis.map.off('zoomstart', this._onZoomStart, this);\n\t\tthis.map.off('zoomend', this._onZoomEnd, this);\n\t},\n\n\t_onClickDropDown: function(event) {\n\t\t$('.drop-down-field-list').show();\n\t\tevent.stopPropagation();\n\t},\n\n\t_onListItemSelect: function(event) {\n\t\t$('.drop-down-field-list').hide();\n\t\tevent.stopPropagation();\n\n\t\tif (this._buttonData.params.items.length === 0)\n\t\t\treturn;\n\n\t\t$('.drop-down-field-list-item.selected').removeClass('selected');\n\t\tevent.target.classList.add('selected');\n\n\n\t\t// Find item index\n\t\tvar index = $(event.target).index();\n\n\t\tvar message = 'formfieldevent {\"type\": \"drop-down\",' +\n\t\t\t\t\t  '\"cmd\": \"selected\",' +\n\t\t\t\t\t  '\"data\":\"' + index.toString() + '\"}';\n\n\t\t// Apply selection in the document.\n\t\tapp.socket.sendMessage(message);\n\t},\n\n\t_onZoomStart: function() {\n\t\t$('.drop-down-field-list').hide();\n\t\tthis._clearButton();\n\t},\n\n\t_onZoomEnd: function() {\n\t\t// rebuild button on zoom\n\t\tthis.onAdd(this.map);\n\t},\n\n\t_clearButton: function() {\n\t\tthis.getPane('formfieldPane').replaceChildren();\n\t}\n\n});\n"]}