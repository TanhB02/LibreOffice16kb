{"version":3,"file":"LayoutingService.js","sourceRoot":"","sources":["../../../../../../../../../../TanhX/online/browser/src/app/LayoutingService.ts"],"names":[],"mappings":"AAAA,kDAAkD;AAmBlD;IAAA;QACS,oBAAe,GACtB,IAAI,CAAC;QACE,iBAAY,GAAyB,EAAE,CAAC;QACxC,qBAAgB,GAAyC,IAAI,CAAC;QAEtE,wEAAwE;QAChE,yBAAoB,GAAG,EAAE,CAAC;QAC1B,uBAAkB,GAAG,EAAE,CAAC;IAiEjC,CAAC;IA/DO,8CAAmB,GAA1B,UAA2B,IAAmB;QAC7C,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAC7B,IAAI,CAAC,kBAAkB,EAAE,CAAC;IAC3B,CAAC;IAEM,0CAAe,GAAtB;QACC,OAAO,IAAI,CAAC,YAAY,CAAC,MAAM,GAAG,CAAC,CAAC;IACrC,CAAC;IAEM,wCAAa,GAApB;QACC,IAAM,IAAI,GAAG,IAAI,CAAC,YAAY,CAAC,KAAK,EAAE,CAAC;QACvC,IAAI,CAAC,IAAI;YAAE,OAAO,KAAK,CAAC;QAExB,IAAI;YACH,IAAI,EAAE,CAAC;SACP;QAAC,OAAO,EAAE,EAAE;YACZ,OAAO,CAAC,KAAK,CAAC,2BAA2B,GAAG,EAAE,CAAC,CAAC;SAChD;QAED,OAAO,IAAI,CAAC;IACb,CAAC;IAEM,sCAAW,GAAlB;QACC,IAAI,IAAI,CAAC,eAAe;YAAE,MAAM,CAAC,oBAAoB,CAAC,IAAI,CAAC,eAAe,CAAC,CAAC;QAC5E,IAAI,CAAC,eAAe,GAAG,IAAI,CAAC;IAC7B,CAAC;IAED,gCAAgC;IAExB,sCAAW,GAAnB;QACC,IAAI,CAAC,gBAAgB,GAAG,UAAU,CACjC,IAAI,CAAC,oBAAoB,CAAC,IAAI,CAAC,IAAI,CAAC,EACpC,IAAI,CAAC,kBAAkB,CACvB,CAAC;IACH,CAAC;IAEO,8CAAmB,GAA3B,UAA4B,KAAa;QACxC,IAAM,QAAQ,GAAG,WAAW,CAAC,GAAG,EAAE,GAAG,KAAK,CAAC;QAC3C,IAAI,QAAQ,GAAG,IAAI,CAAC,oBAAoB;YAAE,OAAO,IAAI,CAAC;QACtD,OAAO,KAAK,CAAC;IACd,CAAC;IAEO,+CAAoB,GAA5B;QAAA,iBAeC;QAdA,IAAI,CAAC,gBAAgB,GAAG,IAAI,CAAC;QAC7B,IAAI,CAAC,IAAI,CAAC,eAAe,EAAE;YAAE,OAAO;QAEpC,IAAI,CAAC,eAAe,GAAG,MAAM,CAAC,qBAAqB,CAAC;YACnD,KAAI,CAAC,eAAe,GAAG,IAAI,CAAC;YAE5B,IAAM,KAAK,GAAG,WAAW,CAAC,GAAG,EAAE,CAAC;YAChC,OAAO,KAAI,CAAC,aAAa,EAAE,EAAE;gBAC5B,IAAI,KAAI,CAAC,mBAAmB,CAAC,KAAK,CAAC,EAAE;oBACpC,KAAI,CAAC,kBAAkB,EAAE,CAAC;oBAC1B,OAAO;iBACP;aACD;QACF,CAAC,CAAC,CAAC;IACJ,CAAC;IAEO,6CAAkB,GAA1B;QACC,IAAI,IAAI,CAAC,gBAAgB;YAAE,OAAO;QAClC,IAAI,CAAC,WAAW,EAAE,CAAC;IACpB,CAAC;IACF,uBAAC;AAAD,CAAC,AAzED,IAyEC","sourcesContent":["/* -*- js-indent-level: 8; fill-column: 100 -*- */\n\n/*\n * Copyright the Collabora Online contributors.\n *\n * SPDX-License-Identifier: MPL-2.0\n *\n * This Source Code Form is subject to the terms of the Mozilla Public\n * License, v. 2.0. If a copy of the MPL was not distributed with this\n * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n */\n\n/*\n * This file contains service which will coordinate intensive DOM modifications\n * which may impact browser rendering performance.\n */\n\ntype LayoutingTask = () => void;\n\nclass LayoutingService {\n\tprivate _requestedFrame: ReturnType<typeof requestAnimationFrame> | null =\n\t\tnull;\n\tprivate _layoutTasks: Array<LayoutingTask> = [];\n\tprivate _layoutTaskFlush: ReturnType<typeof setTimeout> | null = null;\n\n\t// get something around 25 fps as minimum (35ms + some overflow = ~40ms)\n\tprivate MAX_TASK_DURATION_MS = 35;\n\tprivate MIN_TIMER_DELAY_MS = 10;\n\n\tpublic appendLayoutingTask(task: LayoutingTask): void {\n\t\tthis._layoutTasks.push(task);\n\t\tthis._scheduleLayouting();\n\t}\n\n\tpublic hasTasksPending(): boolean {\n\t\treturn this._layoutTasks.length > 0;\n\t}\n\n\tpublic runTheTopTask(): boolean {\n\t\tconst task = this._layoutTasks.shift();\n\t\tif (!task) return false;\n\n\t\ttry {\n\t\t\ttask();\n\t\t} catch (ex) {\n\t\t\tconsole.error('LayoutingTask exception: ' + ex);\n\t\t}\n\n\t\treturn true;\n\t}\n\n\tpublic cancelFrame() {\n\t\tif (this._requestedFrame) window.cancelAnimationFrame(this._requestedFrame);\n\t\tthis._requestedFrame = null;\n\t}\n\n\t// internal implementation below\n\n\tprivate _setupTimer() {\n\t\tthis._layoutTaskFlush = setTimeout(\n\t\t\tthis._flushLayoutingQueue.bind(this),\n\t\t\tthis.MIN_TIMER_DELAY_MS,\n\t\t);\n\t}\n\n\tprivate _reachedTaskTimeout(start: number): boolean {\n\t\tconst duration = performance.now() - start;\n\t\tif (duration > this.MAX_TASK_DURATION_MS) return true;\n\t\treturn false;\n\t}\n\n\tprivate _flushLayoutingQueue(): void {\n\t\tthis._layoutTaskFlush = null;\n\t\tif (!this.hasTasksPending()) return;\n\n\t\tthis._requestedFrame = window.requestAnimationFrame(() => {\n\t\t\tthis._requestedFrame = null;\n\n\t\t\tconst start = performance.now();\n\t\t\twhile (this.runTheTopTask()) {\n\t\t\t\tif (this._reachedTaskTimeout(start)) {\n\t\t\t\t\tthis._scheduleLayouting();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\tprivate _scheduleLayouting(): void {\n\t\tif (this._layoutTaskFlush) return;\n\t\tthis._setupTimer();\n\t}\n}\n"]}