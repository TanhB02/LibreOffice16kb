{"version":3,"file":"MultiPageViewLayout.js","sourceRoot":"","sources":["../../../../../../../../../../TanhX/online/browser/src/app/MultiPageViewLayout.ts"],"names":[],"mappings":"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","sourcesContent":["// @ts-strict-ignore\n/* -*- js-indent-level: 8 -*- */\n/*\n * Copyright the Collabora Online contributors.\n *\n * SPDX-License-Identifier: MPL-2.0\n *\n * This Source Code Form is subject to the terms of the Mozilla Public\n * License, v. 2.0. If a copy of the MPL was not distributed with this\n * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n */\n\nclass LayoutPageRectangle extends cool.SimpleRectangle {\n\t// X and Y coordinates of the rectangle in multi page view.\n\tlayoutX: number = 0;\n\tlayoutY: number = 0;\n\tpart: number;\n}\n\nclass MultiPageViewLayout {\n\tpublic static gapBetweenPages = 20; // Core pixels.\n\tpublic static availableWidth = 0;\n\tprivate static maxRowsSize = 2;\n\tpublic static layoutRectangles = Array<LayoutPageRectangle>();\n\n\tprivate static sendClientVisibleArea() {\n\t\tconst visibleArea = this.getVisibleAreaRectangle();\n\n\t\tconst visibleAreaCommand =\n\t\t\t'clientvisiblearea x=' +\n\t\t\tvisibleArea.x1 +\n\t\t\t' y=' +\n\t\t\tvisibleArea.y1 +\n\t\t\t' width=' +\n\t\t\tvisibleArea.width +\n\t\t\t' height=' +\n\t\t\tvisibleArea.height;\n\t\t+' splitx=' + Math.round(0) + ' splity=' + Math.round(0);\n\n\t\tapp.socket.sendMessage(visibleAreaCommand);\n\n\t\treturn new L.Bounds(\n\t\t\tnew L.Point(visibleArea.pX1, visibleArea.pY1),\n\t\t\tnew L.Point(visibleArea.pX2, visibleArea.pY2),\n\t\t);\n\t}\n\n\tprivate static resetViewLayout() {\n\t\tthis.layoutRectangles.length = 0;\n\n\t\tconst canvasSize = app.sectionContainer.getViewSize();\n\n\t\t// Copy the page rectangle array.\n\t\tfor (let i = 0; i < app.file.writer.pageRectangleList.length; i++) {\n\t\t\tconst temp = app.file.writer.pageRectangleList[i];\n\t\t\tthis.layoutRectangles.push(\n\t\t\t\tnew LayoutPageRectangle(temp[0], temp[1], temp[2], temp[3]),\n\t\t\t);\n\n\t\t\tconst currentPageRectangle = this.layoutRectangles[i];\n\t\t\tcurrentPageRectangle.part = i;\n\t\t}\n\n\t\tlet lastY = this.gapBetweenPages;\n\t\tapp.view.size.pX = canvasSize[0];\n\n\t\tfor (let i = 0; i < this.layoutRectangles.length; i++) {\n\t\t\tlet x = 0;\n\n\t\t\tlet j = i;\n\t\t\tlet totalWidth = 0;\n\t\t\tlet go = true;\n\n\t\t\twhile (\n\t\t\t\tgo &&\n\t\t\t\tj - i < this.maxRowsSize &&\n\t\t\t\tj < this.layoutRectangles.length\n\t\t\t) {\n\t\t\t\tconst addition = this.layoutRectangles[j].pWidth + this.gapBetweenPages;\n\t\t\t\tif (x + addition < canvasSize[0] || j === i) {\n\t\t\t\t\tif (x + addition > canvasSize[0]) {\n\t\t\t\t\t\tgo = false;\n\t\t\t\t\t}\n\n\t\t\t\t\tx += addition;\n\t\t\t\t\ttotalWidth += this.layoutRectangles[j].pWidth;\n\n\t\t\t\t\tj++;\n\t\t\t\t} else go = false;\n\t\t\t}\n\n\t\t\tif (x < canvasSize[0]) {\n\t\t\t\tconst rowItemCount = j - i;\n\t\t\t\tconst gap = (rowItemCount - 1) * this.gapBetweenPages;\n\t\t\t\tconst margin = (canvasSize[0] - totalWidth + gap) * 0.5;\n\t\t\t\tlet currentX = margin + app.file.viewedRectangle.pX1;\n\t\t\t\tlet maxY = 0;\n\t\t\t\tfor (let k = i; k < j; k++) {\n\t\t\t\t\tthis.layoutRectangles[k].layoutX = currentX;\n\t\t\t\t\tthis.layoutRectangles[k].layoutY = lastY;\n\t\t\t\t\tcurrentX += this.layoutRectangles[k].pWidth + this.gapBetweenPages;\n\t\t\t\t\tmaxY = Math.max(maxY, this.layoutRectangles[k].pHeight);\n\t\t\t\t}\n\n\t\t\t\tlastY += maxY + this.gapBetweenPages;\n\t\t\t} else {\n\t\t\t\tif (x > app.view.size.pX)\n\t\t\t\t\tapp.view.size.pX = x + this.gapBetweenPages * 2;\n\n\t\t\t\tthis.layoutRectangles[i].layoutX = this.gapBetweenPages;\n\t\t\t\tthis.layoutRectangles[i].layoutY = lastY;\n\t\t\t\tlastY += this.layoutRectangles[i].pHeight + this.gapBetweenPages;\n\t\t\t}\n\n\t\t\ti = j - 1;\n\t\t}\n\n\t\tapp.view.size.pY = Math.max(lastY, canvasSize[1]);\n\t}\n\n\tpublic static getVisibleAreaRectangle() {\n\t\tconst viewedRectangle = app.file.viewedRectangle.clone();\n\t\tviewedRectangle.pWidth = app.view.size.pX;\n\t\tviewedRectangle.pHeight = app.view.size.pY;\n\t\tconst resultingRectangle = new cool.SimpleRectangle(\n\t\t\tNumber.POSITIVE_INFINITY,\n\t\t\tNumber.POSITIVE_INFINITY,\n\t\t\tNumber.NEGATIVE_INFINITY,\n\t\t\tNumber.NEGATIVE_INFINITY,\n\t\t);\n\n\t\tfor (let i = 0; i < this.layoutRectangles.length; i++) {\n\t\t\tconst rectangle = this.layoutRectangles[i];\n\t\t\tconst controlRectangle = [\n\t\t\t\trectangle.layoutX,\n\t\t\t\trectangle.layoutY,\n\t\t\t\trectangle.pWidth,\n\t\t\t\trectangle.pHeight,\n\t\t\t];\n\t\t\tconst intersection = LOUtil._getIntersectionRectangle(\n\t\t\t\tviewedRectangle.pToArray(),\n\t\t\t\tcontrolRectangle,\n\t\t\t);\n\n\t\t\tif (intersection) {\n\t\t\t\tif (resultingRectangle.pX1 > rectangle.pX1)\n\t\t\t\t\tresultingRectangle.pX1 = rectangle.pX1;\n\n\t\t\t\tif (resultingRectangle.pY1 > rectangle.pY1)\n\t\t\t\t\tresultingRectangle.pY1 = rectangle.pY1;\n\n\t\t\t\tif (resultingRectangle.pX2 < rectangle.pX2)\n\t\t\t\t\tresultingRectangle.pX2 = rectangle.pX2;\n\n\t\t\t\tif (resultingRectangle.pY2 < rectangle.pY2)\n\t\t\t\t\tresultingRectangle.pY2 = rectangle.pY2;\n\t\t\t}\n\t\t}\n\n\t\tresultingRectangle.pX1 -= TileManager.tileSize;\n\t\tresultingRectangle.pY1 -= TileManager.tileSize;\n\t\tresultingRectangle.pWidth += TileManager.tileSize * 2;\n\t\tresultingRectangle.pHeight += TileManager.tileSize * 2;\n\n\t\treturn resultingRectangle;\n\t}\n\n\tpublic static reset() {\n\t\tif (\n\t\t\t!app.file.writer.multiPageView ||\n\t\t\t!app.file.writer.pageRectangleList.length\n\t\t)\n\t\t\treturn;\n\n\t\tthis.resetViewLayout();\n\t\tapp.map._docLayer._sendClientZoom();\n\t\tconst bounds = this.sendClientVisibleArea();\n\t\tTileManager.updateLayoutView(bounds);\n\t}\n}\n"]}