{"version":3,"file":"Permission.js","sourceRoot":"","sources":["../../../../../../../../../../TanhX/online/browser/src/control/Permission.js"],"names":[],"mappings":"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","sourcesContent":["/* -*- js-indent-level: 8 -*- */\n/*\n * Copyright the Collabora Online contributors.\n *\n * SPDX-License-Identifier: MPL-2.0\n *\n * This Source Code Form is subject to the terms of the Mozilla Public\n * License, v. 2.0. If a copy of the MPL was not distributed with this\n * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n */\n/*\n * Document permission handler\n */\n/* global app $ _ */\nL.Map.include({\n\treadonlyStartingFormats: {\n\t\t'txt': { canEdit: true, odfFormat: 'odt' },\n\t\t'csv': { canEdit: true, odfFormat: 'ods' },\n\t\t'xlsb': { canEdit: false, odfFormat: 'ods' }\n\t},\n\n\tsetPermission: function (perm) {\n\t\tvar button = $('#mobile-edit-button');\n\t\tbutton.off('click');\n\t\tbutton.attr('tabindex', 0);\n\t\tbutton.attr('role', 'button');\n\t\tbutton.attr('title', _('Edit document'));\n\t\tbutton.attr('aria-label', _('Edit document'));\n\t\t// app.file.fileBasedView is new view that has continuous scrolling\n\t\t// used for PDF and we don't permit editing for PDFs\n\t\t// this._shouldStartReadOnly() is a check for files that should start in readonly mode and even on desktop browser\n\t\t// we warn the user about loosing the rich formatting and offer an option to\n\t\t// save as ODF instead of the current format\n\t\t//\n\t\t// For mobile we need to display the edit button for all the cases except for PDF\n\t\t// we offer save-as to another place where the user can edit the document\n\t\tvar isPDF = app.file.fileBasedView && app.file.editComment;\n\t\tif (!isPDF && (this._shouldStartReadOnly() || window.mode.isMobile() || window.mode.isTablet())) {\n\t\t\tbutton.css('display', 'flex');\n\t\t} else {\n\t\t\tbutton.hide();\n\t\t}\n\t\tvar that = this;\n\t\tif (perm === 'edit') {\n\t\t\tif (this._shouldStartReadOnly() || window.mode.isMobile() || window.mode.isTablet()) {\n\t\t\t\tbutton.on('click', function () {\n\t\t\t\t\tthat._switchToEditMode();\n\t\t\t\t});\n\n\t\t\t\t// temporarily, before the user touches the floating action button\n\t\t\t\tthis._enterReadOnlyMode('readonly');\n\t\t\t}\n\t\t\telse if (this.options.canTryLock) {\n\t\t\t\t// This is a success response to an attempt to lock using mobile-edit-button\n\t\t\t\tthis._switchToEditMode();\n\t\t\t}\n\t\t\telse {\n\t\t\t\tthis._enterEditMode(perm);\n\t\t\t}\n\t\t}\n\t\telse if (perm === 'view' || perm === 'readonly') {\n\t\t\tif (this.isLockedReadOnlyUser()) {\n\t\t\t\tbutton.on('click', function () {\n\t\t\t\t\tthat.openUnlockPopup();\n\t\t\t\t});\n\t\t\t}\n\t\t\telse if (window.ThisIsTheAndroidApp) {\n\t\t\t\tbutton.on('click', function () {\n\t\t\t\t\tthat._requestFileCopy();\n\t\t\t\t});\n\t\t\t} else if ((!window.ThisIsAMobileApp && !this['wopi'].UserCanWrite) || (!this.options.canTryLock && (window.mode.isMobile() || window.mode.isTablet()))) {\n\t\t\t\t$('#mobile-edit-button').hide();\n\t\t\t}\n\n\t\t\tthis._enterReadOnlyMode(perm);\n\t\t}\n\t},\n\n\tonLockFailed: function(reason) {\n\t\tif (this.options.canTryLock === undefined) {\n\t\t\t// This is the initial notification. This status is not permanent.\n\t\t\t// Allow to try to lock the file for edit again.\n\t\t\tthis.options.canTryLock = true;\n\n\t\t\tvar alertMsg = _('The document could not be locked, and is opened in read-only mode.');\n\t\t\tif (reason) {\n\t\t\t\talertMsg += '\\n' + _('Server returned this reason:') + '\\n\"' + reason + '\"';\n\t\t\t}\n\t\t\tthis.uiManager.showConfirmModal('lock_failed_message', '', alertMsg, _('OK'), function() {\n\t\t\t\tapp.socket.sendMessage('attemptlock');\n\t\t\t}, true);\n\t\t}\n\t\telse if (this.options.canTryLock) {\n\t\t\t// This is a failed response to an attempt to lock using mobile-edit-button\n\t\t\talertMsg = _('The document could not be locked.');\n\t\t\tif (reason) {\n\t\t\t\talertMsg += '\\n' + _('Server returned this reason:') + '\\n\"' + reason + '\"';\n\t\t\t}\n\t\t\tthis.uiManager.showConfirmModal('lock_failed_message', '', alertMsg, _('OK'), null, true);\n\t\t}\n\t\t// do nothing if this.options.canTryLock is defined and is false\n\t},\n\n\t_getFileExtension: function (filename) {\n\t\treturn filename.substring(filename.lastIndexOf('.') + 1);\n\t},\n\n\t_shouldStartReadOnly: function () {\n\t\tif (this.isLockedReadOnlyUser())\n\t\t\treturn true;\n\t\tvar fileName = this['wopi'].BaseFileName;\n\t\t// use this feature for only integration.\n\t\tif (!fileName) return false;\n\t\tvar extension = this._getFileExtension(fileName);\n\t\tif (!Object.prototype.hasOwnProperty.call(this.readonlyStartingFormats, extension))\n\t\t\treturn false;\n\t\treturn true;\n\t},\n\n\t_proceedEditMode: function() {\n\t\tvar fileName = this['wopi'].BaseFileName;\n\t\tif (fileName) {\n\t\t\tvar extension = this._getFileExtension(fileName);\n\t\t\tvar extensionInfo = this.readonlyStartingFormats[extension];\n\t\t\tif (extensionInfo && !extensionInfo.canEdit)\n\t\t\t\treturn;\n\t\t}\n\t\tthis.options.canTryLock = false; // don't respond to lockfailed anymore\n\t\t$('#mobile-edit-button').hide();\n\t\tthis._enterEditMode('edit');\n\t\tif (window.mode.isMobile() || window.mode.isTablet()) {\n\t\t\tthis.fire('editorgotfocus');\n\t\t\tthis.fire('closemobilewizard');\n\t\t\t// In the iOS/android app, just clicking the mobile-edit-button is\n\t\t\t// not reason enough to pop up the on-screen keyboard.\n\t\t\tif (!(window.ThisIsTheiOSApp || window.ThisIsTheAndroidApp))\n\t\t\t\tthis.focus();\n\t\t}\n\t},\n\n\t_offerSaveAs: function() {\n\t\tvar fileName = this['wopi'].BaseFileName;\n\t\tif (!fileName) return false;\n\t\tvar extension = this._getFileExtension(fileName);\n\t\tvar extensionInfo = this.readonlyStartingFormats[extension];\n\t\tvar saveAsFormat = extensionInfo.odfFormat;\n\n\t\tvar defaultValue = fileName.substring(0, fileName.lastIndexOf('.')) + '.' + saveAsFormat;\n\t\tthis.uiManager.showInputModal('save-as-modal', '', _('Enter a file name'), defaultValue, _('OK'), function() {\n\t\t\tvar value = document.getElementById('save-as-modal').querySelectorAll('#input-modal-input')[0].value;\n\t\t\tif (!value)\n\t\t\t\treturn;\n\t\t\telse if (value.substring(value.lastIndexOf('.') + 1) !== saveAsFormat) {\n\t\t\t\tvalue += '.' + saveAsFormat;\n\t\t\t}\n\t\t\tthis.saveAs(value, saveAsFormat);\n\t\t}.bind(this));\n\t},\n\n\t// from read-only to edit mode\n\t_switchToEditMode: function () {\n\t\t// This will be handled by the native mobile app instead\n\t\tif (this._shouldStartReadOnly() && !window.ThisIsAMobileApp) {\n\t\t\tvar fileName = this['wopi'].BaseFileName;\n\t\t\tvar extension = this._getFileExtension(fileName);\n\t\t\tvar extensionInfo = this.readonlyStartingFormats[extension];\n\n\t\t\tvar yesButtonText = !this['wopi'].UserCanNotWriteRelative ? _('Save as ODF format'): null;\n\t\t\tvar noButtonText = extensionInfo.canEdit ? _('Continue editing') : _('Continue read only');\n\n\t\t\tif (!yesButtonText) {\n\t\t\t\tyesButtonText = noButtonText;\n\t\t\t\tnoButtonText = null;\n\t\t\t}\n\n\t\t\tvar yesFunction = !noButtonText ? function() { this._proceedEditMode(); }.bind(this) : function() { this._offerSaveAs(); }.bind(this);\n\t\t\tvar noFunction = function() { this._proceedEditMode(); }.bind(this);\n\n\t\t\tthis.uiManager.showYesNoButton(\n\t\t\t\t'switch-to-edit-mode-modal', // id.\n\t\t\t\t'', // Title.\n\t\t\t\t_('This document may contain formatting or content that cannot be saved in the current file format.'), // Message.\n\t\t\t\tyesButtonText,\n\t\t\t\tnoButtonText,\n\t\t\t\tyesFunction,\n\t\t\t\tnoFunction,\n\t\t\t\tfalse // Cancellable.\n\t\t\t);\n\t\t} else {\n\t\t\tthis._proceedEditMode();\n\t\t}\n\t},\n\n\t_requestFileCopy: function() {\n\t\tif (app.isReadOnly()) {\n\t\t\twindow.postMobileMessage('REQUESTFILECOPY');\n\t\t} else {\n\t\t\tthis._switchToEditMode();\n\t\t}\n\t},\n\n\t_enterEditMode: function (perm) {\n\t\tthis._permission = perm;\n\n\t\tif ((window.mode.isMobile() || window.mode.isTablet()) && this._textInput && this.getDocType() === 'text') {\n\t\t\tthis._textInput.setSwitchedToEditMode();\n\t\t}\n\n\t\tapp.events.fire('updatepermission', {perm : perm});\n\n\t\tif (this._docLayer._docType === 'text') {\n\t\t\tthis.setZoom(10);\n\t\t}\n\n\t\tif (window.ThisIsTheiOSApp && window.mode.isTablet() && this._docLayer._docType === 'spreadsheet')\n\t\t\tthis.showCalcInputBar();\n\n\t\tif (window.ThisIsTheAndroidApp)\n\t\t\twindow.postMobileMessage('EDITMODE on');\n\t},\n\n\t_enterReadOnlyMode: function (perm) {\n\t\tthis._permission = perm;\n\n\t\t// disable all user interaction, will need to add keyboard too\n\t\tif (this._docLayer) {\n\t\t\tthis._docLayer._onUpdateCursor();\n\t\t\tthis._docLayer._clearSelections();\n\t\t\tthis._docLayer._onUpdateTextSelection();\n\t\t}\n\t\tapp.events.fire('updatepermission', {perm : perm});\n\t\tthis.fire('closemobilewizard');\n\t\tthis.fire('closealldialogs');\n\n\t\tif (window.ThisIsTheAndroidApp)\n\t\t\twindow.postMobileMessage('EDITMODE off');\n\t},\n\n\t// Is user currently in read only mode (i.e: initial mobile read only view mode, user may have write access)\n\tisReadOnlyMode: function() {\n\t\treturn this._permission === 'readonly';\n\t},\n\n\t// Is user currently in editing mode\n\tisEditMode: function() {\n\t\treturn this._permission === 'edit';\n\t}\n});\n"]}