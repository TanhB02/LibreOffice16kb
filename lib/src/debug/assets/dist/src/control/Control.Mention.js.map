{"version":3,"file":"Control.Mention.js","sourceRoot":"","sources":["../../../../../../../../../../TanhX/online/browser/src/control/Control.Mention.ts"],"names":[],"mappings":"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","sourcesContent":["// @ts-strict-ignore\n/* -*- js-indent-level: 8 -*- */\n/*\n * Copyright the Collabora Online contributors.\n *\n * SPDX-License-Identifier: MPL-2.0\n *\n * This Source Code Form is subject to the terms of the Mozilla Public\n * License, v. 2.0. If a copy of the MPL was not distributed with this\n * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n */\n/*\n * Control.Mention\n */\n\n/* global app */\n\ninterface MentionUserData {\n\tusername: string;\n\tprofile: string;\n\tlabel?: string;\n}\n\nclass Mention extends L.Control.AutoCompletePopup {\n\tmap: ReturnType<typeof L.map>;\n\tnewPopupData: PopupData;\n\tusers: Array<MentionUserData>;\n\tfilteredUsers: Array<MentionUserData>;\n\tdata: MessageEvent<any>;\n\tdebouceTimeoutId: NodeJS.Timeout;\n\tpartialMention: Array<string>;\n\ttypingMention: boolean;\n\tlastTypedChar: string;\n\tcursorPosAtStart: Point;\n\n\tconstructor(map: ReturnType<typeof L.map>) {\n\t\tsuper('mentionPopup', map);\n\t}\n\n\tonAdd() {\n\t\tthis.newPopupData.isAutoCompletePopup = true;\n\t\tthis.typingMention = false;\n\t\tthis.partialMention = [];\n\t\tthis.cursorPosAtStart = { x: 0, y: 0 } as Point;\n\t}\n\n\tsendMentionPostMsg(partialText: string) {\n\t\tif (this.debouceTimeoutId) clearTimeout(this.debouceTimeoutId);\n\n\t\t// happens when user deletes last character before '@'\n\t\t// if we send empty string to the WOPIHost. They might return us list\n\t\t// with thousand of users\n\t\tif (partialText === '') {\n\t\t\tthis.closeMentionPopup(true);\n\t\t\treturn;\n\t\t}\n\n\t\tthis.debouceTimeoutId = setTimeout(() => {\n\t\t\tthis.map.fire('postMessage', {\n\t\t\t\tmsgId: 'UI_Mention',\n\t\t\t\targs: { type: 'autocomplete', text: partialText },\n\t\t\t});\n\t\t}, 300);\n\t}\n\n\tgetPopupEntries(users: Array<MentionUserData>): any[] {\n\t\tconst entries: Array<TreeEntryJSON> = [];\n\t\tif (users === null) return entries;\n\n\t\tconst text = this.getPartialMention();\n\n\t\t// filterout the users from list according to the text\n\t\tif (text.length > 1) {\n\t\t\tthis.filteredUsers = users.filter((element: any) => {\n\t\t\t\tconst uid = element.label ?? element.username;\n\n\t\t\t\t// case insensitive\n\t\t\t\treturn uid.toLowerCase().includes(text.toLowerCase());\n\t\t\t});\n\t\t} else {\n\t\t\tthis.filteredUsers = users;\n\t\t}\n\n\t\tif (this.filteredUsers.length !== 0) {\n\t\t\tfor (const i in this.filteredUsers) {\n\t\t\t\tconst currentUser = this.filteredUsers[i];\n\t\t\t\tconst entry = {\n\t\t\t\t\ttext: currentUser.label ?? currentUser.username,\n\t\t\t\t\tcolumns: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttext: currentUser.label ?? currentUser.username,\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t\trow: i.toString(),\n\t\t\t\t} as TreeEntryJSON;\n\t\t\t\tentries.push(entry);\n\t\t\t}\n\t\t}\n\t\treturn entries;\n\t}\n\n\topenMentionPopup(users: Array<MentionUserData>) {\n\t\tif (!this.typingMention) return;\n\n\t\tconst entries = this.getPopupEntries(users);\n\t\tconst commentSection = app.sectionContainer.getSectionWithName(\n\t\t\tL.CSections.CommentList.name,\n\t\t);\n\n\t\tconst isMobileCommentActive = commentSection?.isMobileCommentActive();\n\t\tconst mobileCommentModalId = commentSection?.getMobileCommentModalId();\n\t\tif (entries.length === 0 && this.isMobile && isMobileCommentActive) {\n\t\t\tconst control = this.getTreeJSON();\n\t\t\tcontrol.hideIfEmpty = true;\n\t\t\tconst data = this.getPopupJSON(control, { x: 0, y: 0 });\n\t\t\tdata.id = mobileCommentModalId;\n\t\t\t(data.control as TreeWidgetJSON).entries = [];\n\t\t\tthis.sendUpdate(data);\n\t\t\treturn;\n\t\t}\n\n\t\t// change start position if cursor Y position changes.\n\t\t// It happens when user is typing mention at the end where there is no\n\t\t// horizontal space and whole '@mention' goes to new line\n\t\tconst currentPos = this.getCursorPosition();\n\t\tlet cursorPos = { ...this.cursorPosAtStart }; // Make a copy so changes to cursorPos don’t affect the original position\n\t\tif (this.cursorPosAtStart.y !== currentPos.y) {\n\t\t\tcursorPos = currentPos;\n\t\t\tthis.cursorPosAtStart = currentPos;\n\t\t}\n\t\t// popup mention should have total top margin of navigation bar + if toolbar present then toolbar height\n\t\tvar canvasEl = this.map._docLayer._canvas.getBoundingClientRect();\n\t\tcursorPos.y += canvasEl.top;\n\t\tif (entries.length === 0) {\n\t\t\t// If the key pressed was a space, and there are no matches, then just\n\t\t\t// dismiss the popup.\n\t\t\tconst noMatchOnSpace = this.getPartialMention().indexOf(' ');\n\t\t\tif (noMatchOnSpace !== -1) {\n\t\t\t\tthis.closeMentionPopup(false);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst control = this.getSimpleTextJSON();\n\t\t\tif (L.DomUtil.get(this.popupId + 'fixedtext')) {\n\t\t\t\tconst data = this.getPopupJSON(control, cursorPos);\n\t\t\t\tthis.sendUpdate(data);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (L.DomUtil.get(this.popupId)) this.closeMentionPopup(true);\n\t\t\tconst data = this.newPopupData;\n\t\t\tdata.children[0].children[0] = control;\n\t\t\tdata.posx = cursorPos.x;\n\t\t\tdata.posy = cursorPos.y;\n\t\t\tthis.sendJSON(data);\n\t\t\treturn;\n\t\t}\n\n\t\tconst control = this.getTreeJSON();\n\t\tif (isMobileCommentActive) control.hideIfEmpty = true;\n\t\tif (L.DomUtil.get(this.popupId + 'List')) {\n\t\t\tconst data = this.getPopupJSON(control, cursorPos);\n\t\t\tif (isMobileCommentActive) data.id = mobileCommentModalId;\n\t\t\t(data.control as TreeWidgetJSON).entries = entries;\n\t\t\tthis.sendUpdate(data);\n\t\t\treturn;\n\t\t}\n\n\t\tif (L.DomUtil.get(this.popupId)) this.closeMentionPopup(true);\n\t\tconst data = this.newPopupData;\n\t\tdata.children[0].children[0] = control;\n\t\t(data.children[0].children[0] as TreeWidgetJSON).entries = entries;\n\t\tdata.posx = cursorPos.x;\n\t\tdata.posy = cursorPos.y;\n\t\tthis.sendJSON(data);\n\t}\n\n\tprivate getSimpleTextJSON(): TextWidget {\n\t\treturn {\n\t\t\tid: this.popupId + 'fixedtext',\n\t\t\ttype: 'fixedtext',\n\t\t\ttext: _('No search results found!'),\n\t\t\tenabled: true,\n\t\t} as TextWidget;\n\t}\n\n\tcloseMentionPopup(typingMention: boolean): void {\n\t\tthis.typingMention = typingMention;\n\t\tif (!typingMention) this.partialMention = [];\n\n\t\tconst mentionPopup =\n\t\t\tL.DomUtil.get(this.popupId) ||\n\t\t\tL.DomUtil.get(this.popupId + 'List') ||\n\t\t\tL.DomUtil.get(this.popupId + 'fixedtext');\n\t\tif (!mentionPopup) return;\n\n\t\tthis.map.jsdialog.focusToLastElement(this.popupId);\n\t\tif (this.isMobile) {\n\t\t\tconst commentSection = app.sectionContainer.getSectionWithName(\n\t\t\t\tL.CSections.CommentList.name,\n\t\t\t);\n\t\t\tconst isMobileCommentActive = commentSection?.isMobileCommentActive();\n\t\t\tconst mobileCommentModalId = commentSection?.getMobileCommentModalId();\n\n\t\t\tif (isMobileCommentActive) {\n\t\t\t\tconst control = this.getTreeJSON();\n\t\t\t\tcontrol.hideIfEmpty = true;\n\t\t\t\tconst data = this.getPopupJSON(control, { x: 0, y: 0 });\n\t\t\t\tdata.id = mobileCommentModalId;\n\t\t\t\t(data.control as TreeWidgetJSON).entries = [];\n\t\t\t\tthis.sendUpdate(data);\n\t\t\t} else {\n\t\t\t\tthis.map.fire('closemobilewizard');\n\t\t\t}\n\t\t} else this.map.jsdialog.clearDialog(this.popupId);\n\t}\n\n\t// get partialMention excluding '@'\n\tgetPartialMention(): string {\n\t\treturn this.partialMention.join('').substring(1);\n\t}\n\n\tisTypingMention(): boolean {\n\t\treturn this.typingMention;\n\t}\n\n\thandleMentionInput(ev: any, newPara: boolean) {\n\t\tif (!this.typingMention) {\n\t\t\tconst isAtSymbol = ev.data === '@';\n\t\t\tconst isLastCharAtOrSpace =\n\t\t\t\tthis.lastTypedChar === ' ' || this.lastTypedChar === '@';\n\t\t\tif ((newPara && isAtSymbol) || (isAtSymbol && isLastCharAtOrSpace)) {\n\t\t\t\tthis.partialMention.push(ev.data);\n\t\t\t\tthis.typingMention = true;\n\t\t\t\tthis.cursorPosAtStart = this.getCursorPosition();\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis.lastTypedChar = ev.data;\n\t\t\treturn;\n\t\t}\n\n\t\tconst deleteEvent =\n\t\t\tev.inputType === 'deleteContentBackward' ||\n\t\t\tev.inputType === 'deleteContentForward';\n\t\tif (deleteEvent) {\n\t\t\tconst ch = this.partialMention.pop();\n\t\t\tif (ch === '@') this.closeMentionPopup(false);\n\t\t\telse this.sendMentionPostMsg(this.getPartialMention());\n\t\t\treturn;\n\t\t}\n\n\t\tif (ev.data === '@' && this.partialMention.length === 1) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst regEx = /^[0-9a-zA-Z ]+$/;\n\t\tif (ev.data && ev.data.match(regEx)) {\n\t\t\tthis.partialMention.push(ev.data);\n\t\t\tthis.sendMentionPostMsg(this.getPartialMention());\n\t\t} else {\n\t\t\tthis.closeMentionPopup(false);\n\t\t}\n\t}\n\n\tgetMentionUserData(index: number): MentionUserData {\n\t\tif (index >= this.filteredUsers.length)\n\t\t\treturn { username: '', profile: '', label: null } as MentionUserData;\n\t\treturn this.filteredUsers[index];\n\t}\n\n\tprivate sendHyperlinkUnoCommand(\n\t\tuid: string,\n\t\tprofile: string,\n\t\treplacement: string,\n\t) {\n\t\tvar command = {\n\t\t\t'Hyperlink.Text': {\n\t\t\t\ttype: 'string',\n\t\t\t\tvalue: '@' + uid,\n\t\t\t},\n\t\t\t'Hyperlink.URL': {\n\t\t\t\ttype: 'string',\n\t\t\t\tvalue: profile,\n\t\t\t},\n\t\t\t'Hyperlink.ReplacementText': {\n\t\t\t\ttype: 'string',\n\t\t\t\tvalue: replacement,\n\t\t\t},\n\t\t};\n\t\tthis.map.sendUnoCommand('.uno:SetHyperlink', command, true);\n\t}\n\n\tcallback(objectType: any, eventType: any, object: any, index: number) {\n\t\tconst commentSection = app.sectionContainer.getSectionWithName(\n\t\t\tL.CSections.CommentList.name,\n\t\t);\n\t\tconst comment = commentSection?.getActiveEdit();\n\t\tif (eventType === 'close') {\n\t\t\tthis.closeMentionPopup(false);\n\t\t} else if (eventType === 'select' || eventType === 'activate') {\n\t\t\tconst username = this.filteredUsers[index].username;\n\t\t\tconst profileLink = this.filteredUsers[index].profile;\n\t\t\tconst label = this.filteredUsers[index].label;\n\t\t\tconst replacement = '@' + this.getPartialMention();\n\n\t\t\tif (comment) {\n\t\t\t\tcomment.autoCompleteMention(\n\t\t\t\t\tlabel ?? username,\n\t\t\t\t\tprofileLink,\n\t\t\t\t\treplacement,\n\t\t\t\t);\n\t\t\t} else {\n\t\t\t\tthis.sendHyperlinkUnoCommand(\n\t\t\t\t\tlabel ?? username,\n\t\t\t\t\tprofileLink,\n\t\t\t\t\treplacement,\n\t\t\t\t);\n\t\t\t\tthis.map._textInput._sendText(' ');\n\t\t\t}\n\t\t\tthis.map.fire('postMessage', {\n\t\t\t\tmsgId: 'UI_Mention',\n\t\t\t\targs: { type: 'selected', username: username, label: label },\n\t\t\t});\n\t\t\tthis.closeMentionPopup(false);\n\t\t} else if (eventType === 'keydown') {\n\t\t\tif (object.key !== 'Tab' && object.key !== 'Shift') {\n\t\t\t\tif (comment) comment.focus();\n\t\t\t\telse this.map.focus();\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n}\nL.control.mention = function (map: any) {\n\treturn new Mention(map);\n};\n"]}