{"version":3,"file":"AutoCompletePopup.js","sourceRoot":"","sources":["../../../../../../../../../../TanhX/online/browser/src/control/AutoCompletePopup.ts"],"names":[],"mappings":"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","sourcesContent":["// @ts-strict-ignore\n/* -*- js-indent-level: 8 -*- */\n/*\n * Copyright the Collabora Online contributors.\n *\n * SPDX-License-Identifier: MPL-2.0\n *\n * This Source Code Form is subject to the terms of the Mozilla Public\n * License, v. 2.0. If a copy of the MPL was not distributed with this\n * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n */\n/*\n * AutoCompletePopup - base class for mention, formula auto complete, auto fill popup and auto fill preview popup\n */\n\n/* global app */\n\ninterface Point {\n\tx: number;\n\ty: number;\n}\n\ninterface FireEvent {\n\tdata?: any;\n}\n\ninterface CloseMessageEvent extends FireEvent {\n\ttypingMention?: boolean;\n}\ninterface MentionEvent extends FireEvent {\n\ttriggerKey?: string;\n}\n\nabstract class AutoCompletePopup {\n\tprotected map: ReturnType<typeof L.map>;\n\tprotected newPopupData: PopupData;\n\tprotected data: MessageEvent<any>;\n\tprotected popupId: string;\n\tprotected isMobile: boolean;\n\n\tconstructor(popupId: string, map: ReturnType<typeof L.map>) {\n\t\tthis.map = map;\n\t\tthis.popupId = popupId;\n\t\tthis.newPopupData = {\n\t\t\tchildren: [\n\t\t\t\t{\n\t\t\t\t\tid: 'container',\n\t\t\t\t\ttype: 'container',\n\t\t\t\t\tenabled: true,\n\t\t\t\t\tchildren: new Array<WidgetJSON>(),\n\t\t\t\t\tvertical: true,\n\t\t\t\t} as any as WidgetJSON,\n\t\t\t] as Array<WidgetJSON>,\n\t\t\tjsontype: 'dialog',\n\t\t\ttype: 'modalpopup',\n\t\t\tcancellable: true,\n\t\t\tpopupParent: '_POPOVER_',\n\t\t\tclickToClose: '_POPOVER_',\n\t\t\tid: this.popupId,\n\t\t\tpersistKeyboard: true,\n\t\t} as PopupData;\n\n\t\tthis.isMobile = (<any>window).mode.isMobile();\n\t\tthis.onAdd();\n\t\tthis.map.on('closepopup', this.closePopup, this);\n\t}\n\n\tabstract onAdd(): void;\n\n\tclosePopup(): void {\n\t\tvar popupExists = L.DomUtil.get(this.popupId);\n\t\tif (!popupExists) return;\n\n\t\tthis.map.jsdialog.focusToLastElement(this.popupId);\n\t\tthis.map.jsdialog.clearDialog(this.popupId);\n\t}\n\n\tabstract getPopupEntries(ev: FireEvent): Array<TreeEntryJSON>;\n\n\tgetPopupJSON(control: any, framePos: any): PopupData {\n\t\treturn {\n\t\t\tjsontype: 'dialog',\n\t\t\tid: this.popupId,\n\t\t\taction: 'update',\n\t\t\tcontrol: control,\n\t\t\tposx: framePos.x,\n\t\t\tposy: framePos.y,\n\t\t\tchildren: undefined,\n\t\t} as any as PopupData;\n\t}\n\n\tgetTreeJSON(): TreeWidgetJSON {\n\t\treturn {\n\t\t\tid: this.popupId + 'List',\n\t\t\ttype: 'treelistbox',\n\t\t\ttext: '',\n\t\t\tenabled: true,\n\t\t\tsingleclickactivate: false,\n\t\t\tfireKeyEvents: true,\n\t\t\tentries: [] as Array<TreeEntryJSON>,\n\t\t} as TreeWidgetJSON;\n\t}\n\n\tsendUpdate(data: any): void {\n\t\tthis.map.fire('jsdialogupdate', {\n\t\t\tdata: data,\n\t\t\tcallback: this.callback.bind(this),\n\t\t});\n\t}\n\n\tsendJSON(data: any): void {\n\t\tconst fireEvent = this.isMobile ? 'mobilewizard' : 'jsdialog';\n\t\tthis.map.fire(fireEvent, {\n\t\t\tdata: data,\n\t\t\tcallback: this.callback.bind(this),\n\t\t});\n\t}\n\n\tgetCursorPosition(): Point {\n\t\tconst commentSection = app.sectionContainer.getSectionWithName(\n\t\t\tL.CSections.CommentList.name,\n\t\t);\n\t\tif (commentSection?.getActiveEdit()) {\n\t\t\tconst caretRect = window\n\t\t\t\t.getSelection()\n\t\t\t\t.getRangeAt(0)\n\t\t\t\t.getBoundingClientRect();\n\t\t\tconst mapRect = this.map._container.getBoundingClientRect();\n\t\t\treturn new L.Point(\n\t\t\t\tcaretRect.left - mapRect.left,\n\t\t\t\tcaretRect.bottom - mapRect.top,\n\t\t\t);\n\t\t}\n\n\t\tconst currPos = {\n\t\t\tx: app.file.textCursor.rectangle.cX1,\n\t\t\ty: app.file.textCursor.rectangle.cY2,\n\t\t};\n\t\tconst origin = this.map.getPixelOrigin();\n\t\tconst panePos = this.map._getMapPanePos();\n\t\treturn new L.Point(\n\t\t\tMath.round(currPos.x + panePos.x - origin.x),\n\t\t\tMath.round(currPos.y + panePos.y - origin.y),\n\t\t);\n\t}\n\n\topenPopup(ev: FireEvent): void {\n\t\tconst entries = this.getPopupEntries(ev);\n\t\tif (entries.length === 0) return;\n\n\t\tconst cursorPos = this.getCursorPosition();\n\t\tconst control = this.getTreeJSON();\n\t\tif (L.DomUtil.get(this.popupId + 'List')) {\n\t\t\tconst data = this.getPopupJSON(control, cursorPos);\n\t\t\t(data.control as TreeWidgetJSON).entries = entries;\n\t\t\tthis.sendUpdate(data);\n\t\t\treturn;\n\t\t}\n\n\t\tif (L.DomUtil.get(this.popupId)) this.closePopup();\n\n\t\tconst data = this.newPopupData;\n\t\tdata.children[0].children[0] = control;\n\t\t(data.children[0].children[0] as TreeWidgetJSON).entries = entries;\n\n\t\tconst isSpreadsheetRTL = this.map._docLayer.isCalcRTL();\n\t\tconst canvasEl = this.map._docLayer._canvas.getBoundingClientRect();\n\t\tconst offsetX = isSpreadsheetRTL\n\t\t\t? 0\n\t\t\t: app.sectionContainer.getSectionWithName(L.CSections.RowHeader.name)\n\t\t\t\t\t.size[0];\n\t\tconst offsetY = app.sectionContainer.getSectionWithName(\n\t\t\tL.CSections.ColumnHeader.name,\n\t\t).size[1];\n\n\t\tif (isSpreadsheetRTL) cursorPos.x = this.map._size.x - cursorPos.x;\n\n\t\tdata.posx = cursorPos.x + offsetX + canvasEl.left;\n\t\tdata.posy = cursorPos.y + offsetY + canvasEl.top;\n\n\t\tthis.sendJSON(data);\n\t}\n\n\tpublic getPopupId() {\n\t\treturn this.popupId;\n\t}\n\n\tcallback(objectType: any, eventType: any, object: any, index: number) {\n\t\tif (eventType === 'keydown') {\n\t\t\tif (object.key !== 'Tab' && object.key !== 'Shift') {\n\t\t\t\tthis.map.focus();\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n}\n\nL.Control.AutoCompletePopup = AutoCompletePopup;\n"]}