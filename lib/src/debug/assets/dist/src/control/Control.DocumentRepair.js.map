{"version":3,"file":"Control.DocumentRepair.js","sourceRoot":"","sources":["../../../../../../../../../../TanhX/online/browser/src/control/Control.DocumentRepair.js"],"names":[],"mappings":"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","sourcesContent":["/* -*- js-indent-level: 8 -*- */\n/*\n * Copyright the Collabora Online contributors.\n *\n * SPDX-License-Identifier: MPL-2.0\n *\n * This Source Code Form is subject to the terms of the Mozilla Public\n * License, v. 2.0. If a copy of the MPL was not distributed with this\n * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n */\n/*\n * L.Control.DocumentRepair.\n */\n/* global _ */\nL.Control.DocumentRepair = L.Control.extend({\n\tbuilder: null,\n\tactions: null,\n\tselected: null,\n\n\taddTo: function (map) {\n\t\tthis.remove();\n\n\t\tvar data = {\n\t\t\tid: 'DocumentRepairDialog',\n\t\t\tdialogid: 'DocumentRepairDialog',\n\t\t\ttype: 'dialog',\n\t\t\ttext: _('Repair Document'),\n\t\t\ttitle: _('Repair Document'),\n\t\t\tjsontype: 'dialog',\n\t\t\tresponses: [\n\t\t\t\t{\n\t\t\t\t\tid: 'ok',\n\t\t\t\t\tresponse: 1\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tid: 'cancel',\n\t\t\t\t\tresponse: 0\n\t\t\t\t},\n\t\t\t],\n\t\t\t'init_focus_id': 'ok',\n\t\t\tenabled: true,\n\t\t\tchildren: [\n\t\t\t\t{\n\t\t\t\t\tid: 'dialog-vbox1',\n\t\t\t\t\ttype: 'container',\n\t\t\t\t\ttext: '',\n\t\t\t\t\tenabled: true,\n\t\t\t\t\tvertical: true,\n\t\t\t\t\tchildren: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttype: 'treelistbox',\n\t\t\t\t\t\t\tid: 'versions',\n\t\t\t\t\t\t\tenabled: false,\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tid: 'dialog-action_area1',\n\t\t\t\t\t\t\ttype: 'container',\n\t\t\t\t\t\t\ttext: '',\n\t\t\t\t\t\t\tenabled: true,\n\t\t\t\t\t\t\tvertical: true,\n\t\t\t\t\t\t\tchildren: [\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tid: '',\n\t\t\t\t\t\t\t\t\ttype: 'buttonbox',\n\t\t\t\t\t\t\t\t\ttext: '',\n\t\t\t\t\t\t\t\t\tenabled: true,\n\t\t\t\t\t\t\t\t\tchildren: [\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\tid: 'cancel',\n\t\t\t\t\t\t\t\t\t\t\ttype: 'pushbutton',\n\t\t\t\t\t\t\t\t\t\t\ttext: _('Cancel'),\n\t\t\t\t\t\t\t\t\t\t\tenabled: true\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\tid: 'ok',\n\t\t\t\t\t\t\t\t\t\t\ttype: 'pushbutton',\n\t\t\t\t\t\t\t\t\t\t\ttext: _('OK'),\n\t\t\t\t\t\t\t\t\t\t\tenabled: true,\n\t\t\t\t\t\t\t\t\t\t\t'has_default': true,\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t\tvertical: false,\n\t\t\t\t\t\t\t\t\tlayoutstyle: 'end'\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t],\n\t\t\t\t\t\t},\n\t\t\t\t\t]\n\t\t\t\t},\n\t\t\t],\n\t\t};\n\n\t\tthis._map = map;\n\t\tthis.actions = [];\n\n\t\tvar dialogBuildEvent = {\n\t\t\tdata: data,\n\t\t\tcallback: this._onAction.bind(this),\n\t\t};\n\n\n\t\tthis._map.fire(window.mode.isMobile() ? 'mobilewizard' : 'jsdialog', dialogBuildEvent);\n\n\t\treturn this;\n\t},\n\n\tcreateAction: function (type, index, comment, viewId, dateTime, action) {\n\t\tthis.actions.push({ 'text': comment, 'columns': [\n\t\t\ttype,\n\t\t\tcomment,\n\t\t\tviewId,\n\t\t\tdateTime\n\t\t].map(\n\t\t\tfunction (item) {\n\t\t\t\treturn { text: item };\n\t\t\t}\n\t\t), 'row': index, 'action': action});\n\t},\n\n\tfillAction: function (actions, type, action) {\n\t\tfor (var iterator = 0; iterator < actions.length; ++iterator) {\n\t\t\t// No user name if the user in question is already disconnected.\n\t\t\tvar userName = actions[iterator].userName ? actions[iterator].userName : '';\n\t\t\tif (parseInt(actions[iterator].viewId) === this._map._docLayer._viewId) {\n\t\t\t\tuserName = _('You');\n\t\t\t}\n\t\t\tthis.createAction(type, actions[iterator].index, actions[iterator].comment, userName, this.transformTimestamp(actions[iterator].dateTime), action);\n\t\t}\n\t},\n\n\tshow: function () {\n\t\tif (this.actions.length !== 0) {\n\t\t\tvar dialogUpdateEvent = {\n\t\t\t\tdata: {\n\t\t\t\t\tjsontype: 'dialog',\n\t\t\t\t\taction: 'update',\n\t\t\t\t\tid: 'DocumentRepairDialog',\n\t\t\t\t\tcontrol: {\n\t\t\t\t\t\tid: 'versions',\n\t\t\t\t\t\ttype: 'treelistbox',\n\t\t\t\t\t\theaders: [_('Type'), _('What?'), _('Who?'), _('When?')].map(\n\t\t\t\t\t\t\tfunction(item) { return { text: item }; }\n\t\t\t\t\t\t),\n\t\t\t\t\t\ttext: '',\n\t\t\t\t\t\tenabled: true,\n\t\t\t\t\t\tentries: this.actions,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tcallback: this._onAction.bind(this)\n\t\t\t};\n\t\t} else {\n\t\t\tvar dialogUpdateEvent = {\n\t\t\t\tdata: {\n\t\t\t\t\tjsontype: 'dialog',\n\t\t\t\t\taction: 'update',\n\t\t\t\t\tid: 'DocumentRepairDialog',\n\t\t\t\t\tcontrol: {\n\t\t\t\t\t\tid: 'versions',\n\t\t\t\t\t\ttype: 'fixedtext',\n\t\t\t\t\t\ttext: _('You have not done anything to rollback yet...'),\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\t\tif (window.mode.isMobile()) window.mobileDialogId = dialogUpdateEvent.data.id;\n\t\tthis._map.fire('jsdialogupdate', dialogUpdateEvent);\n\t},\n\n\tfillActions: function (data) {\n\t\tthis.fillAction(data.Redo.actions, _('Redo'), 'Redo');\n\t\tthis.fillAction(data.Undo.actions, _('Undo'), 'Undo');\n\t},\n\n\t_onAction: function(element, action, data, index) {\n\t\tif (element === 'dialog' && action === 'close') return;\n\t\tif (element === 'treeview') {\n\t\t\tvar entry = data.entries[parseInt(index)];\n\t\t\tthis.selected = {\n\t\t\t\taction: entry.action,\n\t\t\t\tindex: parseInt(entry.row),\n\t\t\t};\n\t\t\treturn;\n\t\t}\n\t\tif (element === 'responsebutton' && data.id == 'ok' && this.selected) {\n\t\t\tthis._onOk(this.selected.action, this.selected.index);\n\t\t}\n\n\t\tvar closeEvent = {\n\t\t    data: {\n\t\t\t\taction: 'close',\n\t\t\t\tid: 'DocumentRepairDialog',\n\t\t\t}\n\t\t};\n\t\tthis._map.fire(window.mode.isMobile() ? 'closemobilewizard' : 'jsdialog', closeEvent);\n\t\tconsole.log('Closed after' + element + ' ' + action);\n\t},\n\n\t_onOk: function (action, index) {\n\t\tvar command = {\n\t\t\tRepair: {\n\t\t\t\ttype: 'boolean',\n\t\t\t\tvalue: true\n\t\t\t}\n\t\t};\n\t\tcommand[action] = {\n\t\t\ttype: 'unsigned short',\n\t\t\tvalue: index + 1\n\t\t};\n\t\tthis._map.sendUnoCommand('.uno:' + action, command, true);\n\t},\n\n\t// Transform timestamp from ISO8601 to human readable format with Local time\n\ttransformTimestamp: function (timestamp) {\n\t\tvar d = new Date(timestamp.split(',')[0] + 'Z');\n\t\tvar dateOptions = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };\n\t\tvar formattedDateTime = d.toLocaleString(String.locale, dateOptions);\n\t\treturn formattedDateTime;\n\t}\n});\n\nL.control.documentRepair = function (options) {\n\treturn new L.Control.DocumentRepair(options);\n};\n"]}