{"version":3,"file":"LayersCompositor.js","sourceRoot":"","sources":["../../../../../../../../../../TanhX/online/browser/src/slideshow/LayersCompositor.ts"],"names":[],"mappings":"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","sourcesContent":["// @ts-strict-ignore\n/* -*- js-indent-level: 8 -*- */\n\n/*\n * Copyright the Collabora Online contributors.\n *\n * SPDX-License-Identifier: MPL-2.0\n *\n * This Source Code Form is subject to the terms of the Mozilla Public\n * License, v. 2.0. If a copy of the MPL was not distributed with this\n * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n */\n\n/*\n * LayersCompositor generates slide from layers\n */\n\ndeclare var SlideShow: any;\n\nclass LayersCompositor extends SlideCompositor {\n\tprivate layerDrawing: LayerDrawing; // setup in constructor\n\tprivate metaPresentation: MetaPresentation;\n\n\tconstructor(\n\t\tslideShowPresenter: SlideShowPresenter,\n\t\tmetaPres: MetaPresentation,\n\t) {\n\t\tsuper(slideShowPresenter);\n\t\tthis.metaPresentation = metaPres;\n\t}\n\n\tprotected _addHooks() {\n\t\tthis.layerDrawing = new SlideShow.LayerDrawing(app.map, this);\n\t\tthis.layerDrawing.addHooks();\n\t}\n\n\tpublic removeHooks() {\n\t\tthis.layerDrawing.removeHooks();\n\t}\n\n\tpublic fetchAndRun(slideNumber: number, callback: VoidFunction) {\n\t\tsuper.fetchAndRun(slideNumber, callback);\n\t\tthis.layerDrawing.requestSlide(this._initialSlideNumber, () => {\n\t\t\tconst oldCallback = this._onGotSlideCallback;\n\t\t\tthis._onGotSlideCallback = null;\n\t\t\toldCallback();\n\t\t});\n\t}\n\n\tpublic getSlideInfo(slideHash: string): SlideInfo {\n\t\treturn this.metaPresentation.getSlideInfo(slideHash);\n\t}\n\n\tpublic onUpdatePresentationInfo() {\n\t\tthis.layerDrawing.onUpdatePresentationInfo();\n\t\t// TODO: optimize\n\t\tthis.layerDrawing.invalidateAll();\n\t}\n\n\tpublic getSlideHash(slideIndex: number) {\n\t\treturn this.metaPresentation.getSlideHash(slideIndex);\n\t}\n\n\tpublic getAnimatedElement(\n\t\tslideHash: string,\n\t\tanimatedElementHash: string,\n\t): AnimatedElement {\n\t\tconst metaSlide = this.metaPresentation.getMetaSlide(slideHash);\n\t\tif (!metaSlide) {\n\t\t\twindow.app.console.log(\n\t\t\t\t'LayersCompositor.getAnimatedElement: failed to retrieve meta slide for hash: ' +\n\t\t\t\t\tslideHash,\n\t\t\t);\n\t\t\treturn;\n\t\t}\n\t\tif (metaSlide.animationsHandler) {\n\t\t\tconst animElemMap = metaSlide.animationsHandler.getAnimatedElementMap();\n\t\t\treturn animElemMap.get(animatedElementHash);\n\t\t}\n\t}\n\n\tpublic getSlideSizePixel() {\n\t\treturn [\n\t\t\tapp.twipsToPixels * this.metaPresentation.slideWidth,\n\t\t\tapp.twipsToPixels * this.metaPresentation.slideHeight,\n\t\t];\n\t}\n\n\tpublic computeLayerResolution(width: number, height: number) {\n\t\twidth *= 1.2;\n\t\theight *= 1.2;\n\t\tlet resolutionWidth = 960;\n\t\tlet resolutionHeight = 540;\n\n\t\tif (width > 3840 || height > 2160) {\n\t\t\tresolutionWidth = 3840;\n\t\t\tresolutionHeight = 2160;\n\t\t} else if (width > 2560 || height > 1440) {\n\t\t\tresolutionWidth = 2560;\n\t\t\tresolutionHeight = 1440;\n\t\t} else if (width > 1920 || height > 1080) {\n\t\t\tresolutionWidth = 1920;\n\t\t\tresolutionHeight = 1080;\n\t\t} else if (width > 1280 || height > 720) {\n\t\t\tresolutionWidth = 1280;\n\t\t\tresolutionHeight = 720;\n\t\t}\n\t\treturn [resolutionWidth, resolutionHeight];\n\t}\n\n\tpublic computeLayerSize(width: number, height: number) {\n\t\t// compute the slide size in pixel with respect to the current resolution\n\t\tconst slideWidth = this.metaPresentation.slideWidth;\n\t\tconst slideHeight = this.metaPresentation.slideHeight;\n\t\tconst slideRatio = slideWidth / slideHeight;\n\t\tconst resolutionRatio = width / height;\n\t\tif (slideRatio > resolutionRatio) {\n\t\t\theight = Math.trunc((width * slideHeight) / slideWidth);\n\t\t} else if (slideRatio < resolutionRatio) {\n\t\t\twidth = Math.trunc((height * slideWidth) / slideHeight);\n\t\t}\n\t\treturn [width, height];\n\t}\n\n\t// return [width, height]\n\tpublic getCanvasSize(): [number, number] {\n\t\treturn this.layerDrawing.getCanvasSize();\n\t}\n\n\tpublic getSlide(slideNumber: number): ImageBitmap {\n\t\treturn this.layerDrawing.getSlide(slideNumber);\n\t}\n\n\tpublic getLayerRendererContext(): RenderContext {\n\t\treturn this.layerDrawing.getLayerRendererContext();\n\t}\n\n\tpublic getVideoRenderer(\n\t\tslideHash: string,\n\t\tvideoInfo: VideoInfo,\n\t): VideoRenderer {\n\t\treturn this.layerDrawing.getVideoRenderer(slideHash, videoInfo);\n\t}\n\n\tpublic getAnimatedSlide(slideIndex: number): ImageBitmap {\n\t\treturn this.layerDrawing.getAnimatedSlide(slideIndex);\n\t}\n\n\tpublic getAnimatedLayerInfo(\n\t\tslideHash: string,\n\t\ttargetElement: string,\n\t): AnimatedShapeInfo {\n\t\treturn this.layerDrawing.getAnimatedLayerInfo(slideHash, targetElement);\n\t}\n\n\tpublic getLayerImage(slideHash: string, targetElement: string): ImageBitmap {\n\t\treturn this.layerDrawing.getLayerImage(slideHash, targetElement);\n\t}\n\n\tpublic getLayerBounds(\n\t\tslideHash: string,\n\t\ttargetElement: string,\n\t): BoundingBoxType {\n\t\treturn this.layerDrawing.getLayerBounds(slideHash, targetElement);\n\t}\n\n\tpublic isSlideShowPlaying() {\n\t\treturn this._slideShowPresenter._checkAlreadyPresenting();\n\t}\n\n\tpublic deleteResources() {\n\t\tthis.layerDrawing.deleteResources();\n\t}\n\n\tpublic pauseVideos(slideHash: string) {\n\t\tthis.layerDrawing.pauseVideos(slideHash);\n\t}\n\n\tpublic notifyTransitionStart() {\n\t\tthis.layerDrawing.notifyTransitionStart();\n\t}\n\n\tpublic notifyTransitionEnd(slideHash: string) {\n\t\tthis.layerDrawing.notifyTransitionEnd(slideHash);\n\t}\n}\n\nSlideShow.LayersCompositor = LayersCompositor;\n"]}