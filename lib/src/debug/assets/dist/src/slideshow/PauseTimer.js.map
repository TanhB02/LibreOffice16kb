{"version":3,"file":"PauseTimer.js","sourceRoot":"","sources":["../../../../../../../../../../TanhX/online/browser/src/slideshow/PauseTimer.ts"],"names":[],"mappings":"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","sourcesContent":["// @ts-strict-ignore\n/* -*- js-indent-level: 8 -*- */\n\n/*\n * Copyright the Collabora Online contributors.\n *\n * SPDX-License-Identifier: MPL-2.0\n *\n * This Source Code Form is subject to the terms of the Mozilla Public\n * License, v. 2.0. If a copy of the MPL was not distributed with this\n * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n */\n\n/*\n * PauseTimer helps display the countdown in pause mode, and we typically use it to repeat after x pauses\n */\n\ndeclare var SlideShow: any;\n\nabstract class PauseTimer {\n\tpublic abstract startTimer(): void;\n\tpublic abstract stopTimer(): void;\n}\n\nclass PauseTimer2d implements PauseTimer {\n\tprivate onComplete: () => void;\n\tconstructor(\n\t\tcanvasContext: RenderContext2d,\n\t\tpauseDuration: number,\n\t\tonComplete: () => void,\n\t) {\n\t\tthis.onComplete = onComplete;\n\t}\n\n\tpublic startTimer(): void {\n\t\tthis.onComplete();\n\t}\n\n\t// eslint-disable-next-line @typescript-eslint/no-empty-function\n\tpublic stopTimer(): void {}\n}\n\nclass PauseTimerGl extends StaticTextRenderer implements PauseTimer {\n\tprivate pauseTimeRemaining: number;\n\tprivate pauseDuration: number;\n\tprivate onComplete: () => void;\n\tprivate textCanvas: HTMLCanvasElement;\n\tprivate ctx: CanvasRenderingContext2D;\n\n\tconstructor(\n\t\tcanvasContext: RenderContextGl,\n\t\tpauseDuration: number,\n\t\tonComplete: () => void,\n\t) {\n\t\tsuper(canvasContext);\n\t\tthis.pauseDuration = pauseDuration;\n\t\tthis.pauseTimeRemaining = pauseDuration;\n\t\tthis.onComplete = onComplete;\n\n\t\tif (this.context.isDisposed()) return;\n\n\t\tthis.textCanvas = document.createElement('canvas');\n\t\tthis.textCanvas.width = this.context.canvas.width;\n\t\tthis.textCanvas.height = this.context.canvas.height;\n\t\tthis.ctx = this.textCanvas.getContext('2d');\n\n\t\tthis.textTexture = this.createTextTexture(this.getPauseTextContent());\n\t\tthis.prepareTransition();\n\t}\n\n\tpublic startTimer(): void {\n\t\tif (this.context.isDisposed()) return;\n\n\t\tthis.startTime = performance.now();\n\t\trequestAnimationFrame(this.animate.bind(this));\n\t}\n\n\tpublic stopTimer(): void {\n\t\tthis.pauseTimeRemaining = 0;\n\t\tthis.delete2dTextCanvas();\n\t}\n\n\tpublic animate(): void {\n\t\tif (this.context.isDisposed()) return;\n\n\t\tif (!this.textCanvas || !this.ctx) return;\n\t\tconst currentTime = performance.now();\n\t\tconst elapsedTime = (currentTime - this.startTime) / 1000;\n\t\tthis.pauseTimeRemaining = Math.max(0, this.pauseDuration - elapsedTime);\n\n\t\tthis.textTexture = this.createTextTexture(this.getPauseTextContent());\n\n\t\tthis.render();\n\t\trequestAnimationFrame(this.animate.bind(this));\n\n\t\tif (this.pauseTimeRemaining <= 0) {\n\t\t\tthis.onComplete();\n\t\t\tthis.delete2dTextCanvas();\n\t\t\treturn;\n\t\t}\n\t}\n\n\tpublic createTextTexture(displayText: string): WebGLTexture {\n\t\tif (this.context.isDisposed()) return null;\n\n\t\tthis.clearCanvas();\n\t\tthis.drawText(displayText);\n\t\treturn this.load2dCanvasToGlCanvas(this.textCanvas);\n\t}\n\n\tprivate clearCanvas(): void {\n\t\tthis.ctx.clearRect(0, 0, this.textCanvas.width, this.textCanvas.height);\n\t\tthis.ctx.fillStyle = 'black';\n\t\tthis.ctx.fillRect(0, 0, this.textCanvas.width, this.textCanvas.height);\n\t}\n\n\t// add text on off screen canvas...\n\tprivate drawText(displayText: string): void {\n\t\tif (this.context.isDisposed()) return;\n\n\t\tthis.ctx.fillStyle = 'white';\n\t\tthis.ctx.font = '20px sans-serif';\n\t\tthis.ctx.textAlign = 'center';\n\t\tthis.ctx.textBaseline = 'middle';\n\t\tthis.ctx.fillText(\n\t\t\tdisplayText,\n\t\t\tthis.textCanvas.width / 2,\n\t\t\tthis.textCanvas.height / 2,\n\t\t);\n\t}\n\n\tpublic delete2dTextCanvas(): void {\n\t\tif (this.textCanvas) {\n\t\t\tthis.textCanvas.remove();\n\t\t\tthis.textCanvas = null;\n\t\t\tthis.ctx = null;\n\t\t}\n\t}\n\n\tprivate getPauseTextContent(): string {\n\t\treturn _('Pause... ( %SECONDS% )').replace(\n\t\t\t'%SECONDS%',\n\t\t\tMath.ceil(this.pauseTimeRemaining).toString(),\n\t\t);\n\t}\n}\n\nSlideShow.PauseTimer = PauseTimer;\nSlideShow.PauseTimer2d = PauseTimer2d;\nSlideShow.PauseTimerGl = PauseTimerGl;\n"]}