{"version":3,"file":"Transition2d.js","sourceRoot":"","sources":["../../../../../../../../../../TanhX/online/browser/src/slideshow/Transition2d.ts"],"names":[],"mappings":"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","sourcesContent":["// @ts-strict-ignore\n/* -*- js-indent-level: 8 -*- */\n\n/*\n * Copyright the Collabora Online contributors.\n *\n * SPDX-License-Identifier: MPL-2.0\n *\n * This Source Code Form is subject to the terms of the Mozilla Public\n * License, v. 2.0. If a copy of the MPL was not distributed with this\n * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n */\n\ndeclare var SlideShow: any;\n\nclass TransitionParameters {\n\tpublic context: RenderContext = null;\n\tpublic current: WebGLTexture | ImageBitmap = null;\n\tpublic next: WebGLTexture | ImageBitmap = null;\n\tpublic transitionFilterInfo: TransitionFilterInfo = null;\n\tpublic callback: VoidFunction = null;\n}\n\nabstract class TransitionBase extends SlideChangeGl {\n\tprotected transitionFilterInfo: TransitionFilterInfo = null;\n\n\tprotected constructor(transitionParameters: TransitionParameters) {\n\t\tsuper(transitionParameters);\n\t\tthis.transitionFilterInfo = transitionParameters.transitionFilterInfo;\n\t\tthis.createProgram();\n\t\tthis.prepareTransition();\n\t}\n\n\tpublic startTransition(): void {\n\t\tthis.time = null;\n\t\tthis.isLastFrame = false;\n\t\tthis.requestAnimationFrameId = requestAnimationFrame(\n\t\t\tthis.animate.bind(this),\n\t\t);\n\t}\n\n\tpublic start(): void {\n\t\tthis.startTransition();\n\t}\n\n\tpublic endTransition(): void {\n\t\tthis.releaseResources();\n\t\tconsole.debug('Transition completed');\n\t}\n\n\tprivate releaseResources(): void {\n\t\tif (this.context.isDisposed()) return;\n\n\t\t// Clean up vertex array\n\t\tthis.gl.bindVertexArray(null);\n\t\tif (this.vao) {\n\t\t\tthis.gl.deleteVertexArray(this.vao);\n\t\t\tthis.vao = null;\n\t\t}\n\n\t\t// Unbind\n\t\tthis.gl.activeTexture(this.gl.TEXTURE0);\n\t\tthis.gl.bindTexture(this.gl.TEXTURE_2D, null);\n\n\t\t// Detach and delete shaders from the program\n\t\tconst attachedShaders = this.gl.getAttachedShaders(this.program);\n\t\tif (attachedShaders) {\n\t\t\tattachedShaders.forEach((shader) => {\n\t\t\t\tthis.gl.detachShader(this.program, shader);\n\t\t\t\tthis.gl.deleteShader(shader);\n\t\t\t});\n\t\t}\n\n\t\t// Delete the program\n\t\tthis.gl.deleteProgram(this.program);\n\t\tthis.program = null;\n\t}\n\n\t// eslint-disable-next-line @typescript-eslint/no-empty-function\n\tpublic renderUniformValue(): void {}\n}\n\nclass Transition2d extends TransitionBase {\n\tprivate static readonly DefaultFromColor = new Float32Array([0, 0, 0, 0]);\n\tprivate static readonly DefaultToColor = new Float32Array([0, 0, 0, 0]);\n\tprivate _uniformCache = new Map<string, WebGLUniformLocation | null>();\n\n\tconstructor(transitionParameters: TransitionParameters) {\n\t\tsuper(transitionParameters);\n\t}\n\n\tprotected getFragmentShader(): string {\n\t\tconst isSlideTransition: boolean = !!this.leavingSlide;\n\t\treturn `#version 300 es\n\t\t\t\tprecision mediump float;\n\n\t\t\t\t${isSlideTransition ? 'uniform sampler2D leavingSlideTexture;' : ''}\n\t\t\t\tuniform sampler2D enteringSlideTexture;\n\t\t\t\tuniform float time;\n\t\t\t\t${!isSlideTransition ? 'uniform float alpha;' : ''}\n\n\t\t\t\tin vec2 v_texCoord;\n\t\t\t\tout vec4 outColor;\n\n\t\t\t\tvoid main() {\n\t\t\t\t\tvec4 color0 = ${\n\t\t\t\t\t\tisSlideTransition\n\t\t\t\t\t\t\t? 'texture(leavingSlideTexture, v_texCoord)'\n\t\t\t\t\t\t\t: 'vec4(0, 0, 0, 0)'\n\t\t\t\t\t};\n\t\t\t\t\tvec4 color1 = texture(enteringSlideTexture, v_texCoord);\n\t\t\t\t\t${!isSlideTransition ? 'color1 *= alpha;' : ''}\n\t\t\t\t\toutColor = mix(color0, color1, time);\n\t\t\t\t}\n\t\t\t\t`;\n\t}\n\n\tprivate setPositionBuffer(bounds: BoundsType) {\n\t\tif (!bounds) return;\n\n\t\tconst v = [];\n\t\t// convert [0,1] => [-1,1]\n\t\tfor (let i = 0; i < bounds.length; ++i) {\n\t\t\tconst x = 2 * bounds[i].x - 1;\n\t\t\tv.push(x);\n\t\t\t// flip y coordinates\n\t\t\tconst y = -(2 * bounds[i].y - 1);\n\t\t\tv.push(y);\n\t\t}\n\n\t\tconst positions = new Float32Array([\n\t\t\t...[v[0], v[1], 0, 0, 1],\n\t\t\t...[v[2], v[3], 0, 1, 1],\n\t\t\t...[v[4], v[5], 0, 0, 0],\n\t\t\t...[v[6], v[7], 0, 1, 0],\n\t\t]);\n\n\t\tconst gl = this.gl;\n\t\tgl.bindBuffer(gl.ARRAY_BUFFER, this.positionBuffer);\n\t\tgl.bufferData(gl.ARRAY_BUFFER, positions, gl.STATIC_DRAW);\n\t}\n\n\tprivate getUniformLocation(name: string): WebGLUniformLocation | null {\n\t\tif (!this.program) return null;\n\n\t\tif (this._uniformCache.has(name)) {\n\t\t\treturn this._uniformCache.get(name);\n\t\t}\n\n\t\tconst loc = this.gl.getUniformLocation(this.program, name);\n\t\tthis._uniformCache.set(name, loc);\n\t\treturn loc;\n\t}\n\n\tpublic render(nT: number, properties?: AnimatedElementRenderProperties) {\n\t\tif (this.context.isDisposed()) return;\n\n\t\tconst isSlideTransition: boolean = !!this.leavingSlide;\n\n\t\tconsole.debug(`Transition2d.render: nT: ${nT}`);\n\n\t\tconst gl = this.gl;\n\t\tif (isSlideTransition) {\n\t\t\tgl.viewport(0, 0, this.gl.canvas.width, this.gl.canvas.height);\n\t\t\tgl.clearColor(0.0, 0.0, 0.0, 1.0);\n\t\t\tgl.clear(gl.COLOR_BUFFER_BIT);\n\t\t}\n\n\t\tif (!this.program) {\n\t\t\tconsole.error('Transition2d.render: this.program is missing');\n\t\t\treturn;\n\t\t}\n\n\t\tgl.useProgram(this.program);\n\t\tgl.bindVertexArray(this.vao);\n\t\tgl.uniform1f(gl.getUniformLocation(this.program, 'time'), nT);\n\n\t\tif (isSlideTransition) {\n\t\t\tgl.activeTexture(gl.TEXTURE0);\n\t\t\tgl.bindTexture(gl.TEXTURE_2D, this.leavingSlide);\n\t\t\tgl.uniform1i(\n\t\t\t\tgl.getUniformLocation(this.program, 'leavingSlideTexture'),\n\t\t\t\t0,\n\t\t\t);\n\t\t} else {\n\t\t\tconst {\n\t\t\t\tbounds,\n\t\t\t\talpha,\n\t\t\t\tfromFillColor,\n\t\t\t\ttoFillColor,\n\t\t\t\tfromLineColor,\n\t\t\t\ttoLineColor,\n\t\t\t} = LayerRendererGl.computeColor(properties);\n\n\t\t\tconsole.debug(`Transition2d.render: alpha: ${alpha}`);\n\n\t\t\tthis.setPositionBuffer(bounds);\n\t\t\tthis.gl.uniform1f(this.getUniformLocation('alpha'), alpha);\n\t\t\tthis.gl.uniform4fv(\n\t\t\t\tthis.getUniformLocation('fromFillColor'),\n\t\t\t\tfromFillColor,\n\t\t\t);\n\t\t\tthis.gl.uniform4fv(this.getUniformLocation('toFillColor'), toFillColor);\n\t\t\tthis.gl.uniform4fv(\n\t\t\t\tthis.getUniformLocation('fromLineColor'),\n\t\t\t\tfromLineColor,\n\t\t\t);\n\t\t\tthis.gl.uniform4fv(this.getUniformLocation('toLineColor'), toLineColor);\n\t\t}\n\n\t\tgl.activeTexture(gl.TEXTURE1);\n\t\tgl.bindTexture(gl.TEXTURE_2D, this.enteringSlide);\n\t\tgl.uniform1i(\n\t\t\tgl.getUniformLocation(this.program, 'enteringSlideTexture'),\n\t\t\t1,\n\t\t);\n\n\t\tthis.renderUniformValue();\n\n\t\tgl.bindVertexArray(this.vao);\n\t\tgl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);\n\n\t\tif (isSlideTransition) {\n\t\t\tapp.map.fire('newslideshowframe', {\n\t\t\t\tframe: gl.canvas,\n\t\t\t});\n\t\t}\n\t}\n}\n\nSlideShow.Transition2d = Transition2d;\n"]}