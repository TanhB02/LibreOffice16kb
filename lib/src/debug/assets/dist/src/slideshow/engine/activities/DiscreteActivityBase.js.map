{"version":3,"file":"DiscreteActivityBase.js","sourceRoot":"","sources":["../../../../../../../../../../../../TanhX/online/browser/src/slideshow/engine/activities/DiscreteActivityBase.ts"],"names":[],"mappings":"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","sourcesContent":["// @ts-strict-ignore\n/* -*- js-indent-level: 8 -*- */\n\n/*\n * Copyright the Collabora Online contributors.\n *\n * SPDX-License-Identifier: MPL-2.0\n *\n * This Source Code Form is subject to the terms of the Mozilla Public\n * License, v. 2.0. If a copy of the MPL was not distributed with this\n * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n */\n\nabstract class DiscreteActivityBase extends ActivityBase {\n\tprivate aOriginalWakeupEvent: WakeupEvent;\n\tprivate aWakeupEvent: WakeupEvent;\n\tprivate aDiscreteTimes: Array<number>;\n\tprotected nMinSimpleDuration: number;\n\tprotected nCurrPerformCalls: number;\n\n\tprotected constructor(aCommonParamSet: ActivityParamSet) {\n\t\tsuper(aCommonParamSet);\n\n\t\tthis.aOriginalWakeupEvent = aCommonParamSet.aWakeupEvent;\n\t\tthis.aOriginalWakeupEvent.setActivity(this);\n\t\tthis.aWakeupEvent = this.aOriginalWakeupEvent;\n\t\tthis.aWakeupEvent = aCommonParamSet.aWakeupEvent;\n\t\tthis.aDiscreteTimes = aCommonParamSet.aDiscreteTimes;\n\t\t// Simple duration of activity\n\t\tthis.nMinSimpleDuration = aCommonParamSet.nMinDuration;\n\t\t// Actual number of frames shown until now.\n\t\tthis.nCurrPerformCalls = 0;\n\t}\n\n\tpublic activate(aEndElement: any) {\n\t\tsuper.activate(aEndElement);\n\n\t\tthis.aWakeupEvent = this.aOriginalWakeupEvent;\n\t\tthis.aWakeupEvent.setNextTimeout(0);\n\t\tthis.nCurrPerformCalls = 0;\n\t}\n\n\tpublic startAnimation() {\n\t\tthis.aWakeupEvent.start();\n\t}\n\n\tpublic calcFrameIndex(nCurrCalls: number, nVectorSize: number) {\n\t\tif (this.isAutoReverse()) {\n\t\t\t// every full repeat run consists of one\n\t\t\t// forward and one backward traversal.\n\t\t\tlet nFrameIndex = nCurrCalls % (2 * nVectorSize);\n\n\t\t\t// nFrameIndex values >= nVectorSize belong to\n\t\t\t// the backward traversal\n\t\t\tif (nFrameIndex >= nVectorSize)\n\t\t\t\tnFrameIndex = 2 * nVectorSize - nFrameIndex; // invert sweep\n\n\t\t\treturn nFrameIndex;\n\t\t} else {\n\t\t\treturn nCurrCalls % nVectorSize;\n\t\t}\n\t}\n\n\tpublic calcRepeatCount(nCurrCalls: number, nVectorSize: number) {\n\t\tif (this.isAutoReverse()) {\n\t\t\treturn Math.floor(nCurrCalls / (2 * nVectorSize)); // we've got 2 cycles per repeat\n\t\t} else {\n\t\t\treturn Math.floor(nCurrCalls / nVectorSize);\n\t\t}\n\t}\n\n\tprotected abstract performDiscreteHook(\n\t\tnFrame: number,\n\t\tnRepeatCount: number,\n\t): void;\n\t// protected performDiscreteHook(nFrame: number, nRepeatCount: number): void {\n\t// \t// TODO throw abstract\n\t// }\n\n\tpublic perform() {\n\t\t// call base class, for start() calls and end handling\n\t\tif (!super.perform()) return false; // done, we're ended\n\n\t\tconst nVectorSize = this.aDiscreteTimes.length;\n\n\t\tconst nFrameIndex = this.calcFrameIndex(\n\t\t\tthis.nCurrPerformCalls,\n\t\t\tnVectorSize,\n\t\t);\n\t\tconst nRepeatCount = this.calcRepeatCount(\n\t\t\tthis.nCurrPerformCalls,\n\t\t\tnVectorSize,\n\t\t);\n\t\tthis.performDiscreteHook(nFrameIndex, nRepeatCount);\n\n\t\t// one more frame successfully performed\n\t\t++this.nCurrPerformCalls;\n\n\t\t// calc currently reached repeat count\n\t\tlet nCurrRepeat = this.nCurrPerformCalls / nVectorSize;\n\n\t\t// if auto-reverse is specified, halve the\n\t\t// effective repeat count, since we pass every\n\t\t// repeat run twice: once forward, once backward.\n\t\tif (this.isAutoReverse()) nCurrRepeat /= 2;\n\n\t\t// schedule next frame, if either repeat is indefinite\n\t\t// (repeat forever), or we've not yet reached the requested\n\t\t// repeat count\n\t\tif (!this.isRepeatCountValid() || nCurrRepeat < this.getRepeatCount()) {\n\t\t\t// add wake-up event to queue (modulo vector size, to cope with repeats).\n\n\t\t\t// repeat is handled locally, only apply acceleration/deceleration.\n\t\t\t// Scale time vector with simple duration, offset with full repeat\n\t\t\t// times.\n\n\t\t\t// Note that calcAcceleratedTime() is only applied to the current repeat's value,\n\t\t\t// not to the total resulting time. This is in accordance with the SMIL spec.\n\n\t\t\tconst nFrameIndex = this.calcFrameIndex(\n\t\t\t\tthis.nCurrPerformCalls,\n\t\t\t\tnVectorSize,\n\t\t\t);\n\t\t\tconst nCurrentRepeatTime = this.aDiscreteTimes[nFrameIndex];\n\t\t\tconst nRepeatCount = this.calcRepeatCount(\n\t\t\t\tthis.nCurrPerformCalls,\n\t\t\t\tnVectorSize,\n\t\t\t);\n\t\t\tconst nNextTimeout =\n\t\t\t\tthis.nMinSimpleDuration *\n\t\t\t\t(nRepeatCount + this.calcAcceleratedTime(nCurrentRepeatTime));\n\t\t\tthis.aWakeupEvent.setNextTimeout(nNextTimeout);\n\n\t\t\tthis.getEventQueue().addEvent(this.aWakeupEvent);\n\t\t} else {\n\t\t\t// release event reference (relation to wake up event is circular!)\n\t\t\tthis.aWakeupEvent = null;\n\n\t\t\t// done with this activity\n\t\t\tthis.endActivity();\n\t\t}\n\n\t\treturn false; // remove from queue, will be added back by the wakeup event.\n\t}\n\n\tpublic dispose() {\n\t\t// dispose event\n\t\tif (this.aWakeupEvent) this.aWakeupEvent.dispose();\n\n\t\t// release references\n\t\tthis.aWakeupEvent = null;\n\n\t\tsuper.dispose();\n\t}\n}\n"]}