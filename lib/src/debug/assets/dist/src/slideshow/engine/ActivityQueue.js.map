{"version":3,"file":"ActivityQueue.js","sourceRoot":"","sources":["../../../../../../../../../../../TanhX/online/browser/src/slideshow/engine/ActivityQueue.ts"],"names":[],"mappings":"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","sourcesContent":["// @ts-strict-ignore\n/* -*- js-indent-level: 8 -*- */\n\n/*\n * Copyright the Collabora Online contributors.\n *\n * SPDX-License-Identifier: MPL-2.0\n *\n * This Source Code Form is subject to the terms of the Mozilla Public\n * License, v. 2.0. If a copy of the MPL was not distributed with this\n * file, You can obtain one at http://mozilla.org/MPL/2.0/.\n */\n\nclass ActivityQueue {\n\tprivate aTimer: ElapsedTime;\n\tprivate aCurrentActivityWaitingSet: AnimationActivity[];\n\tprivate aCurrentActivityReinsertSet: AnimationActivity[];\n\tprivate aDequeuedActivitySet: AnimationActivity[];\n\n\tconstructor(aTimer: ElapsedTime) {\n\t\tthis.aTimer = aTimer;\n\t\tthis.aCurrentActivityWaitingSet = [];\n\t\tthis.aCurrentActivityReinsertSet = [];\n\t\tthis.aDequeuedActivitySet = [];\n\t}\n\n\taddActivity(aActivity: AnimationActivity) {\n\t\tif (!aActivity) {\n\t\t\twindow.app.console.log(\n\t\t\t\t'ActivityQueue.addActivity: activity is not valid',\n\t\t\t);\n\t\t\treturn false;\n\t\t}\n\n\t\tthis.aCurrentActivityWaitingSet.push(aActivity);\n\t\taActivityQueueDebugPrinter.print(\n\t\t\t'ActivityQueue.addActivity: activity appended',\n\t\t);\n\t\treturn true;\n\t}\n\n\tprocess() {\n\t\tconst nSize = this.aCurrentActivityWaitingSet.length;\n\t\tlet nLag = 0.0;\n\t\tfor (let i = 0; i < nSize; ++i) {\n\t\t\tnLag = Math.max(nLag, this.aCurrentActivityWaitingSet[i].calcTimeLag());\n\t\t}\n\n\t\tif (nLag > 0.0) this.aTimer.adjustTimer(-nLag);\n\n\t\twhile (this.aCurrentActivityWaitingSet.length != 0) {\n\t\t\tconst aActivity = this.aCurrentActivityWaitingSet.shift();\n\t\t\tlet bReinsert = false;\n\n\t\t\tbReinsert = aActivity.perform();\n\n\t\t\tif (bReinsert) {\n\t\t\t\tthis.aCurrentActivityReinsertSet.push(aActivity);\n\t\t\t} else {\n\t\t\t\tthis.aDequeuedActivitySet.push(aActivity);\n\t\t\t}\n\t\t}\n\n\t\tif (this.aCurrentActivityReinsertSet.length != 0) {\n\t\t\t// TODO: optimization, try to swap reference here\n\t\t\tthis.aCurrentActivityWaitingSet = this.aCurrentActivityReinsertSet;\n\t\t\tthis.aCurrentActivityReinsertSet = [];\n\t\t}\n\t}\n\n\tprocessDequeued() {\n\t\t// notify all dequeued activities from last round\n\t\tconst nSize = this.aDequeuedActivitySet.length;\n\t\tfor (let i = 0; i < nSize; ++i) this.aDequeuedActivitySet[i].dequeued();\n\n\t\tthis.aDequeuedActivitySet = [];\n\t}\n\n\tisEmpty() {\n\t\treturn (\n\t\t\tthis.aCurrentActivityWaitingSet.length == 0 &&\n\t\t\tthis.aCurrentActivityReinsertSet.length == 0\n\t\t);\n\t}\n\n\tclear() {\n\t\taActivityQueueDebugPrinter.print('ActivityQueue.clear invoked');\n\t\tlet nSize = this.aCurrentActivityWaitingSet.length;\n\t\tfor (let i = 0; i < nSize; ++i)\n\t\t\tthis.aCurrentActivityWaitingSet[i].dequeued();\n\t\tthis.aCurrentActivityWaitingSet = [];\n\n\t\tnSize = this.aCurrentActivityReinsertSet.length;\n\t\tfor (let i = 0; i < nSize; ++i)\n\t\t\tthis.aCurrentActivityReinsertSet[i].dequeued();\n\t\tthis.aCurrentActivityReinsertSet = [];\n\t}\n\n\tendAll() {\n\t\taActivityQueueDebugPrinter.print('ActivityQueue.endAll invoked');\n\t\tlet nSize = this.aCurrentActivityWaitingSet.length;\n\t\tfor (let i = 0; i < nSize; ++i) this.aCurrentActivityWaitingSet[i].end();\n\t\tthis.aCurrentActivityWaitingSet = [];\n\n\t\tnSize = this.aCurrentActivityReinsertSet.length;\n\t\tfor (let i = 0; i < nSize; ++i) this.aCurrentActivityReinsertSet[i].end();\n\t\tthis.aCurrentActivityReinsertSet = [];\n\t}\n\n\tgetTimer() {\n\t\treturn this.aTimer;\n\t}\n\n\tsize() {\n\t\treturn (\n\t\t\tthis.aCurrentActivityWaitingSet.length +\n\t\t\tthis.aCurrentActivityReinsertSet.length +\n\t\t\tthis.aDequeuedActivitySet.length\n\t\t);\n\t}\n}\n"]}